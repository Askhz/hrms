# 8、开发与部署指南

## 概述

本指南为HRMS（人力资源管理系统）提供全面的开发环境搭建、代码规范、测试策略、部署流程和构建工具使用等开发运维相关指导，帮助开发和运维团队高效进行项目开发、测试和部署工作。

### 系统架构概述

HRMS系统采用分层架构设计，主要包括以下技术组成部分：

- **后端技术栈**: Go语言 + Gin框架 + GORM ORM
- **前端技术栈**: Layui UI框架 + jQuery + 原生JavaScript
- **数据库**: SQLite（开发环境）/ MySQL（生产环境）
- **多数据库支持**: 系统支持多分公司数据库隔离，通过Cookie中的分公司ID动态切换数据库连接
- **权限控制**: 基于角色和资源的权限控制系统，支持细粒度权限定义

### 核心技术特性

1. **动态数据库切换**: 系统通过[`resource/resource.go`](resource/resource.go:30)中的`HrmsDB`函数实现基于Cookie的动态数据库切换，支持多租户架构。

2. **RBAC权限系统**: 采用基于角色的访问控制，权限定义在[`authority_detail`](model/authority.go:35)表中，格式为"create|query|update|delete|excel_add"等操作组合。

3. **多环境配置管理**: 通过`config/`目录下的YAML文件实现多环境配置，支持开发、测试和生产环境的灵活切换。

4. **多分公司数据隔离**: 每个分公司使用独立的数据库实例（如hrms_C001、hrms_C002），通过Cookie中的分公司ID进行识别，确保数据安全隔离。

5. **Cookie认证机制**: 系统采用Cookie方式进行用户认证，Cookie格式为"角色_工号_分公司ID_员工姓名(base64编码)"，实现无状态的会话管理。

### 技术架构详解

#### 动态数据库切换实现

HRMS系统的核心特性之一是动态数据库切换，实现多租户架构。以下是技术实现原理：

1. **数据库连接管理**: 使用[`resource/resource.go`](resource/resource.go)中的`HrmsDB`函数获取数据库连接
2. **Cookie解析**: 从HTTP请求中解析Cookie获取分公司ID
3. **数据库切换**: 根据分公司ID动态切换到对应数据库实例

```go
// 示例：数据库切换实现
func HrmsDB(c *gin.Context) *gorm.DB {
    // 从Cookie获取分公司ID
    cookie, err := c.Cookie("hrms_session")
    if err != nil {
        return defaultDB
    }
    
    // 解析Cookie获取分公司ID
    parts := strings.Split(cookie, "_")
    if len(parts) < 3 {
        return defaultDB
    }
    
    companyID := parts[2]
    
    // 返回对应分公司数据库连接
    return getCompanyDB(companyID)
}
```

#### RBAC权限系统实现

1. **权限数据结构**: 权限信息存储在[`authority_detail`](model/authority.go:35)表中，包含以下字段：
   - 表名: 对应的资源模块
   - 权限内容: 以"|"分隔的权限字符串，如"create|query|update|delete|excel_add"

2. **权限验证流程**:
   - 用户访问页面时，系统检查Cookie中的角色信息
   - 通过`/authority_render/:modelName`路由动态验证权限
   - 根据权限控制前端页面元素显示与隐藏

3. **权限级别**:
   - 超级管理员 (supersys): 系统最高权限
   - 系统管理员 (sys): 各部门人力资源专员
   - 普通员工 (normal): 各部门普通员工

#### 多环境配置管理

系统支持多环境配置管理，通过`config/`目录下的YAML文件实现：

1. **配置文件结构**:
```yaml
# config-dev.yaml 示例
server:
  host: "0.0.0.0"
  port: 8080
  mode: "debug"

database:
  driver: "sqlite"
  connection: "./data/hrms_dev.db"
  max_open_conns: 10
  max_idle_conns: 5

logger:
  level: "debug"
  output: "console"
  file_path: "./logs/hrms.log"

session:
  name: "hrms_session"
  secret: "your-secret-key"
  max_age: 3600
```

2. **环境变量覆盖**:
```bash
# 环境变量会覆盖配置文件中的相应设置
export HRMS_SERVER_PORT=9000
export HRMS_DB_PASSWORD="secure-password"
```

## 1. 开发环境搭建

### 1.1 系统要求

#### 操作系统支持
- Windows 10/11
- Linux（Ubuntu 18.04+）
- macOS 10.14+

#### 软件依赖
- **Go语言环境**: Go 1.15+（推荐Go 1.18+）
- **Git**: 版本控制工具
- **文本编辑器**: VS Code（推荐）、GoLand或其他支持Go的IDE

#### 可选依赖
- **MySQL**: 5.7+ 或 8.0+（生产环境推荐）
- **SQLite**: 3.31+（开发环境默认）
- **Docker**: 20.10+（容器化部署）

### 1.2 开发工具配置

#### Go环境安装

1. 下载并安装Go语言环境：
   ```bash
   # Windows
   # 下载并运行安装包 from https://golang.org/dl/

   # Linux/macOS
   wget https://go.dev/dl/go1.18.linux-amd64.tar.gz
   sudo tar -C /usr/local -xzf go1.18.linux-amd64.tar.gz
   ```

2. 配置环境变量：
   ```bash
   # 添加到 ~/.bashrc 或 ~/.zshrc
   export PATH=$PATH:/usr/local/go/bin
   export GOPATH=$HOME/go
   export PATH=$PATH:$GOPATH/bin
   ```

3. 验证安装：
   ```bash
   go version
   ```

#### IDE配置（VS Code）

1. 安装VS Code
2. 安装Go扩展插件：
   - Go（官方）
   - GoLand（可选）
   - GitLens（Git增强）

3. 配置Go插件：
   - 安装后重启VS Code
   - 接受安装Go工具的提示
   - 配置格式化工具：`gofmt`、`goimports`

#### 项目代码获取

1. 克隆项目仓库：
   ```bash
   git clone [项目仓库地址]
   cd hrms
   ```

2. 安装依赖：
   ```bash
   go mod download
   ```

### 1.3 依赖管理

#### Go模块管理

HRMS项目使用Go Modules进行依赖管理，主要依赖包括：

- **Gin**: HTTP Web框架
- **GORM**: ORM库，支持MySQL和SQLite
- **Viper**: 配置管理库
- **Layui**: 前端UI框架

#### 依赖项查看

```bash
# 查看所有依赖
go list -m all

# 更新依赖
go get -u ./...
go mod tidy
```

### 1.4 开发环境初始化

#### 数据库初始化与多公司架构

HRMS系统支持多公司数据隔离，每个公司使用独立的数据库实例。以下是数据库初始化和管理详细指南：

1. **创建公司数据库**:
   ```bash
   # 使用脚本初始化
   bash scripts/init_database.sh

   # 或手动创建多个分公司数据库
   go run cmd/createdb/main.go -db hrms_C001  # 分公司C001
   go run cmd/createdb/main.go -db hrms_C002  # 分公司C002
   go run cmd/createdb/main.go -db hrms_C003  # 分公司C003
   ```

2. **运行数据库迁移**:
   ```bash
   # 对所有分公司数据库运行迁移
   go run cmd/migrate/main.go
   
   # 或对特定分公司数据库运行迁移
   go run cmd/migrate/main.go -db hrms_C001
   ```

3. **数据库切换原理**:
   系统通过Cookie中的分公司ID动态切换数据库连接，实现数据隔离：
   - 用户登录时，Cookie格式为: `角色_工号_分公司ID_员工姓名(base64编码)`
   - 系统从Cookie解析分公司ID，然后连接到对应数据库
   - 所有后续操作都在该分公司数据库中执行

4. **数据隔离验证**:
   ```bash
   # 使用SQL执行工具验证数据隔离
   go run cmd/sqlexec/main.go -db hrms_C001 -file sql/test_data.sql
   go run cmd/sqlexec/main.go -db hrms_C002 -query "SELECT COUNT(*) FROM staff"
   ```

5. **自定义分公司数据库**:
   ```bash
   # 添加新的分公司数据库
   go run cmd/sqlexec/main.go -db hrms_C004 -file sql/new_company_init.sql
   ```

#### 配置文件设置

1. 复制配置模板：
   ```bash
   cp config/config-dev.yaml.example config/config-dev.yaml
   ```

2. 根据环境修改配置：
   - 开发环境: `config-dev.yaml`
   - 测试环境: `config-test.yaml`
   - 生产环境: `config-prod.yaml`

#### 运行应用

```bash
# 开发模式运行
bash build.sh dev

# 或直接运行
go run main.go
```

应用将在配置的端口启动（默认为8080），可通过浏览器访问：http://localhost:8080

#### 项目结构解析

HRMS项目采用清晰的分层架构组织代码：

```
HRMS项目结构
├── cmd/                  # 命令行工具目录
│   ├── createdb/         # 数据库创建工具
│   ├── migrate/          # 数据库迁移工具
│   └── sqlexec/          # SQL执行工具
├── config/               # 配置文件目录
│   ├── config-dev.yaml   # 开发环境配置
│   └── config-prod.yaml  # 生产环境配置
├── docs/                 # 项目文档目录
├── handler/              # HTTP处理器层 (Controller层)
├── model/                # 数据模型层 (Model层)
├── resource/             # 资源管理目录
├── service/              # 业务逻辑层 (Service层)
├── sql/                  # SQL脚本目录
├── static/               # 静态资源目录 (前端文件)
│   ├── css/              # 样式文件
│   ├── js/               # JavaScript文件
│   └── images/           # 图片资源
├── views/                # HTML模板目录
└── scripts/              # 脚本目录
    └── init_database.sh  # 数据库初始化脚本
```

#### 环境变量配置

为了实现灵活的多环境部署，HRMS系统使用环境变量来管理配置：

1. **开发环境**:
```bash
# Windows (PowerShell)
$env:HRMS_ENV="development"
$env:HRMS_CONFIG_PATH="./config/config-dev.yaml"

# Linux/macOS
export HRMS_ENV="development"
export HRMS_CONFIG_PATH="./config/config-dev.yaml"
```

2. **生产环境**:
```bash
# Windows (PowerShell)
$env:HRMS_ENV="production"
$env:HRMS_CONFIG_PATH="./config/config-prod.yaml"

# Linux/macOS
export HRMS_ENV="production"
export HRMS_CONFIG_PATH="./config/config-prod.yaml"
```

### 1.5 调试环境设置与开发工具

#### 日志配置

HRMS系统内置多级日志系统，配置在`config-dev.yaml`中：

```yaml
logger:
  level: debug  # debug, info, warn, error
  output: console  # console, file
  file_path: ./logs/hrms.log
```

#### 热重载配置

使用Air工具实现热重载（自动重启）：

1. 安装Air：
   ```bash
   go install github.com/cosmtrek/air@latest
   ```

2. 配置Air（创建`.air.toml`文件）：
   ```toml
   root = "."
   tmp_dir = "tmp"
   [build]
     bin = "tmp/main"
     cmd = "go build -o ./tmp/main ."
     delay = 1000
     exclude_dir = ["assets", "tmp", "vendor"]
     exclude_file = []
     exclude_regex = ["_test.go"]
     exclude_unchanged = false
     follow_symlink = false
     send_interrupt = false
     kill_delay = "0s"
   ```

3. 运行Air：
   ```bash
   air
   ```

#### 数据库调试工具

HRMS项目提供了多种数据库调试和管理工具：

1. **SQL执行工具**:
   ```bash
   # 在分公司C001数据库执行SQL查询
   go run cmd/sqlexec/main.go -db hrms_C001 -query "SELECT COUNT(*) FROM staff"
   
   # 执行SQL文件
   go run cmd/sqlexec/main.go -db hrms_C001 -file sql/test_data.sql
   
   # 交互式SQL模式
   go run cmd/sqlexec/main.go -db hrms_C001 -interactive
   ```

2. **数据库连接调试**:
   ```go
   // 在代码中添加调试信息
   func debugDBConnection(c *gin.Context) {
       db := resource.HrmsDB(c)
       if db != nil {
           log.Printf("当前数据库连接: %v", db)
           var result struct {
               Database string
           }
           db.Raw("SELECT database()").Scan(&result)
           log.Printf("当前使用数据库: %s", result.Database)
       }
   }
   ```

#### 开发实用技巧

1. **快速创建测试用户**:
   ```bash
   # 创建超级管理员用户
   go run cmd/sqlexec/main.go -db hrms_C001 -query 'INSERT INTO account (account, password, user_type) VALUES ("admin", "admin1", "supersys")'
   
   # 创建系统管理员用户
   go run cmd/sqlexec/main.go -db hrms_C001 -query 'INSERT INTO account (account, password, user_type) VALUES ("hr001", "password", "sys")'
   
   # 创建普通员工用户
   go run cmd/sqlexec/main.go -db hrms_C001 -query 'INSERT INTO account (account, password, user_type) VALUES ("emp001", "password", "normal")'
   ```

2. **查看权限配置**:
   ```bash
   # 查看所有权限配置
   go run cmd/sqlexec/main.go -db hrms_C001 -query "SELECT * FROM authority_detail"
   
   # 查看特定角色的权限
   go run cmd/sqlexec/main.go -db hrms_C001 -query "SELECT * FROM authority_detail WHERE user_type = 'sys'"
   ```

3. **检查数据库状态**:
   ```bash
   # 检查所有表
   go run cmd/sqlexec/main.go -db hrms_C001 -query ".tables"
   
   # 检查表结构
   go run cmd/sqlexec/main.go -db hrms_C001 -query ".schema staff"
   ```

### 1.6 构建工具详解

HRMS项目提供了功能全面的构建脚[`build.sh`](build.sh)，支持开发、测试、构建、部署等全生命周期管理。

#### 构建脚本核心功能

1. **基础构建命令**:
   ```bash
   # 构建当前平台可执行文件
   bash build.sh build
   
   # 构建所有平台的可执行文件
   bash build.sh build-all
   
   # 清理构建文件
   bash build.sh clean
   ```

2. **运行模式控制**:
   ```bash
   # 开发模式运行
   bash build.sh run-dev
   
   # 生产模式运行
   bash build.sh run-prod
   
   # 自定义配置运行
   bash build.sh run-self
   ```

3. **代码质量保证**:
   ```bash
   # 代码格式化
   bash build.sh fmt
   
   # 静态代码检查
   bash build.sh vet
   
   # 综合代码检查
   bash build.sh lint
   
   # 安全检查
   bash build.sh security
   ```

4. **数据库管理**:
   ```bash
   # 运行数据库迁移
   bash build.sh migrate
   
   # 重置数据库
   bash build.sh migrate-reset
   
   # 针对特定分公司数据库操作
   bash build.sh migrate-db hrms_C001
   bash build.sh migrate-reset-db hrms_C001
   
   # 创建新分公司数据库
   bash build.sh createdb hrms_C003
   ```

5. **容器化部署**:
   ```bash
   # 构建Docker镜像
   bash build.sh docker-build
   
   # 运行Docker容器
   bash build.sh docker-run
   
   # 停止Docker容器
   bash build.sh docker-stop
   ```

6. **打包与部署**:
   ```bash
   # 打包应用（生成各平台发布包）
   bash build.sh package
   
   # 快速部署准备
   bash build.sh deploy
   
   # 安装到系统路径
   bash build.sh install
   ```

#### 高级开发功能

1. **开发热重载**:
   ```bash
   # 启动开发模式（带热重载）
   bash build.sh dev
   ```

2. **性能分析**:
   ```bash
   # 运行性能分析
   bash build.sh profile
   ```

3. **项目备份**:
   ```bash
   # 创建项目备份
   bash build.sh backup
   ```

4. **依赖管理**:
   ```bash
   # 下载依赖
   bash build.sh deps
   
   # 更新依赖
   bash build.sh deps-update
   ```

#### 环境变量配置

构建脚本支持通过环境变量自定义行为：

```bash
# 设置运行环境
ENV=prod bash build.sh run-prod

# 设置服务端口
PORT=9000 bash build.sh run-dev

# 组合使用
ENV=prod PORT=9000 bash build.sh run-prod
```

#### 多分公司部署策略

使用构建脚本进行多分公司部署的完整流程：

```bash
# 1. 创建多个分公司数据库
bash build.sh createdb hrms_C001,hrms_C002,hrms_C003

# 2. 运行数据库迁移到所有分公司
bash build.sh migrate-db hrms_C001
bash build.sh migrate-db hrms_C002
bash build.sh migrate-db hrms_C003

# 3. 构建生产版本
bash build.sh build

# 4. 创建部署包
bash build.sh package

# 5. 部署到生产环境
# 将dist目录中的压缩包分发到目标服务器并解压运行
```

## 2. 代码规范

### 2.1 命名约定

#### Go代码命名

1. **包名**：简短、小写、有意义，无下划线或驼峰
   ```go
   // 好的包名
   package model
   package handler
   package service
   
   // 不好的包名
   package hrmsModels
   package user_handlers
   ```

2. **变量名**：驼峰命名，简短有意义
   ```go
   // 好的变量名
   var userID string
   var isAuthorized bool
   var maxRetryCount int
   
   // 不好的变量名
   var u string
   var auth bool
   var mrc int
   ```

3. **函数名**：动词或动词短语，导出函数首字母大写
   ```go
   // 好的函数名
   func GetUserByID(id string) (*User, error)
   func ValidateCredentials(username, password string) bool
   
   // 不好的函数名
   func user(id string) (*User, error)
   func check(u, p string) bool
   ```

4. **常量**：全大写，用下划线分隔
   ```go
   const MAX_RETRY_COUNT = 3
   const DEFAULT_PAGE_SIZE = 20
   const TOKEN_EXPIRY_DURATION = 24 * time.Hour
   ```

#### 数据库命名

1. **表名**：小写，下划线分隔，复数形式
   ```sql
   -- 好的表名
   CREATE TABLE staff
   CREATE TABLE attendance_records
   CREATE TABLE salary_details
   
   -- 不好的表名
   CREATE TABLE Staff
   CREATE TABLE attendanceRecord
   CREATE TABLE salaryDetails
   ```

2. **字段名**：小写，下划线分隔，有意义
   ```sql
   -- 好的字段名
   staff_id
   first_name
   created_at
   is_active
   
   -- 不好的字段名
   StaffID
   firstName
   creation_date
   activeFlag
   ```

### 2.2 注释规范

#### Go代码注释

1. **公共函数/方法**：
   ```go
   // CreateUser 创建新用户记录
   // 参数:
   //   - user: 用户信息
   // 返回值:
   //   - *User: 创建的用户对象
   //   - error: 错误信息
   func CreateUser(user *User) (*User, error) {
       // 函数实现
   }
   ```

2. **复杂逻辑**：
   ```go
   // 检查用户权限，系统采用基于角色和资源的权限控制
   // 权限内容格式为:create|query|update|delete，用"|"分隔
   func checkPermission(userType, model, action) bool {
       // 实现检查逻辑
   }
   ```

3. **TODO/FIXME注释**：
   ```go
   // TODO: 重构此方法，避免使用硬编码的角色检查
   func legacyPermissionCheck() bool {
       // 实现逻辑
   }
   
   // FIXME: 此处在高并发下可能导致竞态条件
   func updateCounter() int {
       // 实现逻辑
   }
   ```

### 2.3 错误处理

#### 统一错误处理模式

1. **自定义错误类型**：
   ```go
   // 自定义错误类型
   type ValidationError struct {
       Field   string
       Message string
   }

   func (e ValidationError) Error() string {
       return fmt.Sprintf("%s: %s", e.Field, e.Message)
   }

   // 使用示例
   func ValidateUserInput(user *User) error {
       if user.StaffID == "" {
           return ValidationError{Field: "staff_id", Message: "员工ID不能为空"}
       }
       return nil
   }
   ```

2. **包装错误**：
   ```go
   // 使用fmt.Errorf和%w包装错误
   func GetUserFromDB(id string) (*User, error) {
       user, err := db.FindByID("users", id)
       if err != nil {
           return nil, fmt.Errorf("查询用户失败: %w", err)
       }
       return user, nil
   }
   ```

3. **日志记录**：
   ```go
   // 记录错误日志
   func ProcessUserData(userID string) error {
       user, err := GetUserFromDB(userID)
       if err != nil {
           log.Printf("获取用户数据失败: %v", err)
           return err
       }
       // 处理逻辑
   }
   ```

#### HTTP错误响应

```go
// 统一HTTP错误响应格式
func ErrorHandler(c *gin.Context, err error) {
    var statusCode int
    var message string
    
    // 根据错误类型确定状态码和消息
    switch e := err.(type) {
    case ValidationError:
        statusCode = http.StatusBadRequest
        message = e.Error()
    case NotFoundError:
        statusCode = http.StatusNotFound
        message = e.Error()
    default:
        statusCode = http.StatusInternalServerError
        message = "服务器内部错误"
    }
    
    // 记录详细错误（仅服务器错误）
    if statusCode >= 500 {
        log.Printf("服务器错误: %v", err)
    }
    
    c.JSON(statusCode, gin.H{
        "success": false,
        "message": message,
    })
}
```

### 2.4 代码组织

#### 目录结构

HRMS项目采用标准的Go项目布局：

```
hrms/
├── cmd/                    # 应用程序入口点
│   ├── createdb/          # 数据库创建工具
│   ├── migrate/           # 数据库迁移工具
│   └── sqlexec/           # SQL执行工具
├── config/                # 配置文件
│   ├── config-dev.yaml    # 开发环境配置
│   ├── config-test.yaml   # 测试环境配置
│   └── config-prod.yaml   # 生产环境配置
├── handler/               # HTTP处理程序
├── model/                 # 数据模型
├── service/               # 业务逻辑
├── resource/              # 资源和公共组件
├── static/                # 静态资源
│   ├── css/              # 样式文件
│   ├── js/               # JavaScript文件
│   └── images/           # 图片资源
├── views/                 # HTML模板
├── scripts/               # 脚本文件
│   └── init_database.sh   # 数据库初始化脚本
├── docs/                  # 文档
└── sql/                   # SQL文件
```

#### 设计模式应用

1. **MVC模式**：
   ```go
   // Model (model/)
   type Staff struct {
       StaffID   string `gorm:"column:staff_id" json:"staff_id"`
       StaffName string `gorm:"column:staff_name" json:"staff_name"`
       // 其他字段...
   }

   // View (views/) - HTML模板
   // views/staff_manage.html - 员工管理界面

   // Controller (handler/)
   func HandleStaffList(c *gin.Context) {
       // 控制器逻辑
       staffList, err := service.GetAllStaff(c)
       if err != nil {
           c.HTML(http.StatusInternalServerError, "500.html", gin.H{
               "error": err.Error(),
           })
           return
       }
       
       c.HTML(http.StatusOK, "staff_manage.html", gin.H{
           "staff": staffList,
           "title": "员工管理",
       })
   }
   ```

2. **依赖注入**：
   ```go
   // service层接收依赖
   type StaffService struct {
       db *gorm.DB
   }

   func NewStaffService(db *gorm.DB) *StaffService {
       return &StaffService{db: db}
   }

   // handler层接收service依赖
   type StaffHandler struct {
       staffService *StaffService
   }

   func NewStaffHandler(staffService *StaffService) *StaffHandler {
       return &StaffHandler{staffService: staffService}
   }

   // 在main.go中进行依赖注入
   func main() {
       db := initDB()
       
       staffService := service.NewStaffService(db)
       staffHandler := handler.NewStaffHandler(staffService)
       
       // 路由注册
       r := gin.Default()
       r.GET("/staff", staffHandler.HandleStaffList)
   }
   ```

3. **中间件模式**：
   ```go
   // 权限验证中间件
   func AuthMiddleware() gin.HandlerFunc {
       return func(c *gin.Context) {
           cookie, err := c.Cookie("hrms_session")
           if err != nil {
               c.Redirect(http.StatusFound, "/login")
               c.Abort()
               return
           }
           
           // 验证Cookie有效性
           if !validateCookie(cookie) {
               c.Redirect(http.StatusFound, "/login")
               c.Abort()
               return
           }
           
           c.Next()
       }
   }

   // 在路由中使用中间件
   func setupRoutes() {
       r := gin.Default()
       
       // 公开路由
       r.GET("/login", handler.HandleLogin)
       r.POST("/login", handler.HandleLoginSubmit)
       
       // 需要认证的路由组
       auth := r.Group("/")
       auth.Use(AuthMiddleware())
       {
           auth.GET("/dashboard", handler.HandleDashboard)
           auth.GET("/staff", handler.HandleStaffList)
       }
   }
   ```
   
   #### 测试权限系统
   
   ```go
   // 测试权限验证功能
   func TestRBACPermissionCheck(t *testing.T) {
       // 创建测试数据库并填充测试数据
       testDB := createTestDB(t, "hrms_permission_test")
       
       // 添加权限测试数据
       testDB.Exec("INSERT INTO authority_detail (user_type, table_name, authority) VALUES (?, ?, ?)",
           "sys", "staff", "create|query|update|delete")
       testDB.Exec("INSERT INTO authority_detail (user_type, table_name, authority) VALUES (?, ?, ?)",
           "normal", "staff", "query")
       
       tests := []struct {
           name      string
           userType  string
           table     string
           action    string
           expected  bool
       }{
           {"系统管理员创建员工", "sys", "staff", "create", true},
           {"系统管理员删除员工", "sys", "staff", "delete", true},
           {"普通员工创建员工", "normal", "staff", "create", false},
           {"普通员工查看员工", "normal", "staff", "query", true},
       }
       
       for _, tt := range tests {
           t.Run(tt.name, func(t *testing.T) {
               result := service.CheckPermission(tt.userType, tt.table, tt.action)
               assert.Equal(t, tt.expected, result)
           })
       }
   }
   ```
   
   ### 3.3 测试执行与自动化
   
   #### 运行测试
   
   ```bash
   # 运行所有测试
   bash build.sh test
   # 或
   go test ./...
   
   # 运行特定包的测试
   go test ./model
   
   # 运行特定测试函数
   go test ./model -run TestCreateStaff
   
   # 生成测试覆盖率报告
   go test -coverprofile=coverage.out ./...
   go tool cover -html=coverage.out -o coverage.html
   ```
   
   #### 集成测试脚本
   
   ```bash
   #!/bin/bash
   # test.sh - 运行完整的测试套件
   
   set -e
   
   echo "开始运行HRMS测试套件..."
   
   # 1. 运行单元测试
   echo "运行单元测试..."
   go test -v ./handler ./model ./service
   
   # 2. 运行集成测试
   echo "运行集成测试..."
   go test -v -tags=integration ./test/...
   
   # 3. 运行端到端测试
   echo "运行端到端测试..."
   go test -v -tags=e2e ./test/e2e/...
   
   # 4. 生成覆盖率报告
   echo "生成测试覆盖率报告..."
   go test -coverprofile=coverage.out ./...
   go tool cover -html=coverage.out -o coverage.html
   
   echo "测试完成！覆盖率报告已生成至 coverage.html"
   ```
   
   ### 3.4 性能测试
   
   #### 基准测试
   
   ```go
   // 员工查询性能基准测试
   func BenchmarkStaffService_GetAllStaff(b *testing.B) {
       // 准备测试数据
       service := setupTestService()
       
       b.ResetTimer()
       for i := 0; i < b.N; i++ {
           _, err := service.GetAllStaff()
           if err != nil {
               b.Fatal(err)
           }
       }
   }
   
   // 数据库查询性能基准测试
   func BenchmarkDB_Switch(b *testing.B) {
       gin.SetMode(gin.TestMode)
       w := httptest.NewRecorder()
       c, _ := gin.CreateTestContext(w)
       
       // 设置Cookie
       c.Request = &http.Request{
           Header: http.Header{"Cookie": []string{"hrms_session=sys_admin001_C001_admin"}},
       }
       
       b.ResetTimer()
       for i := 0; i < b.N; i++ {
           db := resource.HrmsDB(c)
           if db == nil {
               b.Fatal("无法获取数据库连接")
           }
       }
   }
   ```
   
   #### 运行基准测试
   
   ```bash
   # 运行所有基准测试
   go test -bench=. ./...
   
   # 运行特定基准测试
   go test -bench=BenchmarkStaffService_GetAllStaff ./service
   
   # 生成内存分析报告
   go test -bench=. -memprofile=mem.prof ./...
   go tool pprof mem.prof
   ```

### 3.5 测试环境管理

#### 测试数据隔离

为确保测试不会影响生产数据，HRMS系统采用以下策略：

```go
// 创建独立的测试环境
func setupTestEnvironment(t *testing.T) (*gorm.DB, func()) {
   // 创建唯一的测试数据库名称
   testDBName := fmt.Sprintf("hrms_test_%s_%d", t.Name(), time.Now().UnixNano())
   
   // 创建测试数据库
   db, err := createTestDatabase(testDBName)
   require.NoError(t, err)
   
   // 运行迁移
   err = runMigrations(db)
   require.NoError(t, err)
   
   // 返回清理函数
   cleanup := func() {
       dropTestDatabase(testDBName)
   }
   
   return db, cleanup
}
```

#### 测试数据准备

```go
// 准备测试数据
func seedTestData(t *testing.T, db *gorm.DB) {
   // 创建测试公司
   companies := []model.Company{
       {ID: "C001", Name: "测试公司1"},
       {ID: "C002", Name: "测试公司2"},
   }
   db.Create(&companies)
   
   // 创建测试部门
   departments := []model.Department{
       {CompanyID: "C001", Name: "人事部"},
       {CompanyID: "C001", Name: "财务部"},
       {CompanyID: "C002", Name: "技术部"},
   }
   db.Create(&departments)
   
   // 创建测试员工
   staff := []model.Staff{
       {StaffID: "TEST001", Name: "测试员工1", CompanyID: "C001"},
       {StaffID: "TEST002", Name: "测试员工2", CompanyID: "C001"},
       {StaffID: "TEST003", Name: "测试员工3", CompanyID: "C002"},
   }
   db.Create(&staff)
}
```

## 3. 测试策略

### 3.1 测试层次

HRMS系统采用多层次测试策略，确保代码质量和系统稳定性：

1. **单元测试**: 针对单个函数或方法的测试
2. **集成测试**: 测试组件之间的交互
3. **端到端测试**: 模拟真实用户场景的测试

### 3.2 多分公司测试策略

由于HRMS系统采用多分公司数据隔离架构，测试需要特别注意数据隔离和数据库切换的正确验证：

#### 测试数据库切换机制

```go
// 测试数据库切换功能
func TestDynamicDBSwitching(t *testing.T) {
    // 创建测试环境
    gin.SetMode(gin.TestMode)
    
    // 准备多个测试数据库
    testDatabases := map[string]*gorm.DB{
        "C001": createTestDB(t, "hrms_test_C001"),
        "C002": createTestDB(t, "hrms_test_C002"),
    }
    
    // 模拟HTTP请求
    w := httptest.NewRecorder()
    c, _ := gin.CreateTestContext(w)
    
    // 设置不同公司的Cookie
    tests := []struct {
        name      string
        cookie    string
        expectedDB string
    }{
        {"C001公司Cookie", "supersys_admin001_C001_admin", "hrms_test_C001"},
        {"C002公司Cookie", "sys_hr002_C002_hradmin", "hrms_test_C002"},
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // 设置Cookie
            c.Request = &http.Request{
                Header: http.Header{"Cookie": []string{"hrms_session=" + tt.cookie}},
            }
            
            // 获取数据库连接
            db := resource.HrmsDB(c)
            
            // 验证连接到正确的数据库
            var result struct {
                Database string
            }
            db.Raw("SELECT database()").Scan(&result)
            assert.Contains(t, result.Database, tt.expectedDB)
        })
    }
}
```

### 3.3 单元测试

#### 测试框架

HRMS使用Go内置的`testing`包进行单元测试，可配合使用`testify`等扩展库增强测试能力。

#### 测试编写规范

```go
// model/model_test.go
package model

import (
    "testing"
    "time"
    "github.com/stretchr/testify/assert"
)

// TestCreateStaff 测试员工创建功能
func TestCreateStaff(t *testing.T) {
    // 准备测试数据
    staff := &Staff{
        StaffID:     "TEST001",
        StaffName:   "测试员工",
        Birthday:    time.Now(),
        IdentityNum: "123456789012345678",
        // 其他字段...
    }

    // 执行测试
    result, err := CreateStaff(staff)

    // 验证结果
    assert.NoError(t, err)
    assert.NotNil(t, result)
    assert.Equal(t, "TEST001", result.StaffID)
    assert.Equal(t, "测试员工", result.StaffName)
}

// TestValidateStaffEmail 测试邮箱验证（表驱动测试）
func TestValidateStaffEmail(t *testing.T) {
    testCases := []struct {
        name     string
        email    string
        expected bool
    }{
        {"有效邮箱", "user@example.com", true},
        {"无效邮箱-缺少@", "userexample.com", false},
        {"无效邮箱-缺少域名", "user@", false},
        {"空邮箱", "", false},
    }

    for _, tc := range testCases {
        t.Run(tc.name, func(t *testing.T) {
            result := ValidateStaffEmail(tc.email)
            assert.Equal(t, tc.expected, result)
        })
    }
}
```

#### 模拟依赖

```go
// 使用testify模拟数据库操作
import (
    "testing"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"
    "gorm.io/gorm"
)

// MockDB 模拟数据库
type MockDB struct {
    mock.Mock
}

func (m *MockDB) Create(value interface{}) *gorm.DB {
    args := m.Called(value)
    return args.Get(0).(*gorm.DB)
}

// 使用模拟数据库测试服务层
func TestStaffService_CreateStaff(t *testing.T) {
    // 创建模拟数据库
    mockDB := new(MockDB)
    
    // 设置期望
    mockDB.On("Create", mock.AnythingOfType("*model.Staff")).Return(&gorm.DB{
        Error: nil,
    })
    
    // 创建服务并注入模拟依赖
    service := &StaffService{db: mockDB}
    
    // 测试数据
    staff := &Staff{
        StaffID:   "TEST001",
        StaffName: "测试员工",
    }
    
    // 执行测试
    err := service.CreateStaff(staff)
    
    // 验证
    assert.NoError(t, err)
    mockDB.AssertExpectations(t)
}
```

### 3.4 集成测试

#### 数据库测试

```go
// integration_test.go
package tests

import (
    "testing"
    "path/filepath"
    "github.com/stretchr/testify/assert"
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
    "your-project/model"
)

// setupTestDB 创建测试数据库
func setupTestDB(t *testing.T) *gorm.DB {
    // 使用内存SQLite数据库
    db, err := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{})
    assert.NoError(t, err)
    
    // 自动迁移
    err = db.AutoMigrate(&model.Staff{}, &model.Department{})
    assert.NoError(t, err)
    
    return db
}
```

#### 测试执行与自动化

```bash
# 运行所有测试
bash build.sh test
# 或
go test ./...

# 运行特定包的测试
go test ./model

# 运行特定测试函数
go test ./model -run TestCreateStaff

# 生成测试覆盖率报告
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html
```

#### 集成测试脚本

```bash
#!/bin/bash
# test.sh - 运行完整的测试套件

set -e

echo "开始运行HRMS测试套件..."

# 1. 运行单元测试
echo "运行单元测试..."
go test -v ./handler ./model ./service

# 2. 运行集成测试
echo "运行集成测试..."
go test -v -tags=integration ./test/...

# 3. 运行端到端测试
echo "运行端到端测试..."
go test -v -tags=e2e ./test/e2e/...

# 4. 生成覆盖率报告
echo "生成测试覆盖率报告..."
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html

echo "测试完成！覆盖率报告已生成至 coverage.html"
```

### 3.5 性能测试

#### 基准测试

```go
// 员工查询性能基准测试
func BenchmarkStaffService_GetAllStaff(b *testing.B) {
    // 准备测试数据
    service := setupTestService()
    
    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        _, err := service.GetAllStaff()
        if err != nil {
            b.Fatal(err)
        }
    }
}

// 数据库查询性能基准测试
func BenchmarkDB_Switch(b *testing.B) {
    gin.SetMode(gin.TestMode)
    w := httptest.NewRecorder()
    c, _ := gin.CreateTestContext(w)
    
    // 设置Cookie
    c.Request = &http.Request{
        Header: http.Header{"Cookie": []string{"hrms_session=sys_admin001_C001_admin"}},
    }
    
    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        db := resource.HrmsDB(c)
        if db == nil {
            b.Fatal("无法获取数据库连接")
        }
    }
}
```

#### 运行基准测试

```bash
# 运行所有基准测试
go test -bench=. ./...

# 运行特定基准测试
go test -bench=BenchmarkStaffService_GetAllStaff ./service

# 生成内存分析报告
go test -bench=. -memprofile=mem.prof ./...
go tool pprof mem.prof
```

### 3.6 测试环境管理

#### 测试数据隔离

为确保测试不会影响生产数据，HRMS系统采用以下策略：

```go
// 创建独立的测试环境
func setupTestEnvironment(t *testing.T) (*gorm.DB, func()) {
   // 创建唯一的测试数据库名称
   testDBName := fmt.Sprintf("hrms_test_%s_%d", t.Name(), time.Now().UnixNano())
   
   // 创建测试数据库
   db, err := createTestDatabase(testDBName)
   require.NoError(t, err)
   
   // 运行迁移
   err = runMigrations(db)
   require.NoError(t, err)
   
   // 返回清理函数
   cleanup := func() {
       dropTestDatabase(testDBName)
   }
   
   return db, cleanup
}
```

#### 测试数据准备

```go
// 准备测试数据
func seedTestData(t *testing.T, db *gorm.DB) {
   // 创建测试公司
   companies := []model.Company{
       {ID: "C001", Name: "测试公司1"},
       {ID: "C002", Name: "测试公司2"},
   }
   db.Create(&companies)
   
   // 创建测试部门
   departments := []model.Department{
       {CompanyID: "C001", Name: "人事部"},
       {CompanyID: "C001", Name: "财务部"},
       {CompanyID: "C002", Name: "技术部"},
   }
   db.Create(&departments)
   
   // 创建测试员工
   staff := []model.Staff{
       {StaffID: "TEST001", Name: "测试员工1", CompanyID: "C001"},
       {StaffID: "TEST002", Name: "测试员工2", CompanyID: "C001"},
       {StaffID: "TEST003", Name: "测试员工3", CompanyID: "C002"},
   }
   db.Create(&staff)
}
```

## 4. 部署指南

### 4.1 部署环境规划

#### 环境分类

HRMS系统部署通常分为以下环境：

1. **开发环境**: 开发人员日常开发和单元测试
2. **测试环境**: 集成测试和功能验证
3. **预生产环境**: 生产前最后验证，与生产环境配置一致
4. **生产环境**: 正式运行环境，面向最终用户

#### 硬件资源规划

| 环境 | CPU | 内存 | 存储 | 网络 |
|------|-----|------|------|------|
| 开发 | 2核 | 4GB | 50GB SSD | 100Mbps |
| 测试 | 2核 | 4GB | 100GB SSD | 100Mbps |
| 预生产 | 4核 | 8GB | 200GB SSD | 1Gbps |
| 生产 | 8核+ | 16GB+ | 500GB+ SSD | 1Gbps+ |

#### 网络配置

1. **端口规划**:
  - HTTP服务: 80
  - HTTPS服务: 443
  - 管理接口: 8080
  - 数据库: 3306 (MySQL) 或 文件路径 (SQLite)

2. **安全配置**:
  - 防火墙规则配置
  - SSL/TLS证书配置
  - VPN访问控制

4. **工厂模式**：
   ```go
   // 数据库连接工厂
   type DBFactory interface {
       CreateDB(config DatabaseConfig) (*gorm.DB, error)
   }
   
   type SQLiteFactory struct{}
   func (f SQLiteFactory) CreateDB(config DatabaseConfig) (*gorm.DB, error) {
       return gorm.Open(sqlite.Open(config.Path), &gorm.Config{})
   }
   
   type MySQLFactory struct{}
   func (f MySQLFactory) CreateDB(config DatabaseConfig) (*gorm.DB, error) {
       dsn := fmt.Sprintf("%s:%s@tcp(%s:%d)/%s?charset=utf8mb4&parseTime=True&loc=Local",
           config.User, config.Password, config.Host, config.Port, config.Database)
       return gorm.Open(mysql.Open(dsn), &gorm.Config{})
   }
   
   // 根据环境创建数据库连接
   func CreateDBConnection(env string) (*gorm.DB, error) {
       var factory DBFactory
       var config DatabaseConfig
       
       switch env {
       case "dev":
           factory = SQLiteFactory{}
           config = loadSQLiteConfig()
       case "prod":
           factory = MySQLFactory{}
           config = loadMySQLConfig()
       default:
           return nil, fmt.Errorf("unsupported environment: %s", env)
       }
       
       return factory.CreateDB(config)
   }
   ```

### 4.2 生产环境配置

#### 安全配置

生产环境需要特别注意安全配置：

```bash
# 设置生产环境变量
export DB_PASSWORD="your-secure-password"
export SESSION_SECRET="your-secure-session-secret"
export HRMS_ENV=prod
```

#### 数据库环境配置

生产环境资源要求：

| 环境 | CPU | 内存 | 存储 | 网络 |
|------|-----|------|------|------|
| 生产环境 | 4核 | 8GB+ | 100GB+ SSD | 1Gbps |
| 测试环境 | 2核 | 4GB | 50GB SSD | 100Mbps |

#### 系统环境准备

```bash
# CentOS/RHEL
sudo yum update -y
sudo yum install -y git wget curl

# Ubuntu/Debian
sudo apt-get update -y
sudo apt-get install -y git wget curl
```

#### MySQL环境配置

生产环境推荐使用MySQL数据库：

1. **安装MySQL**:
   ```bash
   # CentOS/RHEL 8
   sudo dnf install -y mysql-server
   sudo systemctl start mysqld
   sudo systemctl enable mysqld
   
   # Ubuntu/Debian
   sudo apt-get install -y mysql-server
   sudo systemctl start mysql
   sudo systemctl enable mysql
   ```

2. **创建数据库和用户**:
   ```sql
   CREATE DATABASE hrms_production CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   CREATE USER 'hrms_user'@'%' IDENTIFIED BY 'secure-password';
   GRANT ALL PRIVILEGES ON hrms_production.* TO 'hrms_user'@'%';
   FLUSH PRIVILEGES;
   ```

3. **MySQL配置优化**:
   在`/etc/mysql/mysql.conf.d/mysqld.cnf`中添加：
   ```ini
   [mysqld]
   innodb_buffer_pool_size = 1G
   innodb_log_file_size = 256M
   max_connections = 200
   query_cache_size = 64M
   ```

### 4.3 应用部署流程

#### 传统部署方式

1. **获取源码**:
   ```bash
   # 克隆项目代码
   git clone https://github.com/your-org/hrms.git
   cd hrms
   git checkout v1.0.0  # 切换到稳定版本标签
   ```

2. **构建应用**:
   ```bash
   # 使用项目提供的构建脚本
   bash build.sh build
   
   # 或直接使用Go命令构建
   go build -o hrms main.go
   ```

3. **数据库初始化**:
   ```bash
   # 运行数据库迁移
   go run cmd/migrate/main.go
   
   # 导入初始数据
   go run cmd/sqlexec/main.go -db hrms_C001 -file sql/sqlite_init.sql
   ```

4. **配置系统服务**:
   创建systemd服务文件`/etc/systemd/system/hrms.service`:
   ```ini
   [Unit]
   Description=HRMS Application Service
   After=network.target mysql.service
   
   [Service]
   Type=simple
   User=hrms
   WorkingDirectory=/opt/hrms
   ExecStart=/opt/hrms/hrms
   Restart=always
   RestartSec=5
   Environment=HRMS_ENV=prod
   
   # 日志配置
   StandardOutput=journal
   StandardError=journal
   
   [Install]
   WantedBy=multi-user.target
   ```

5. **启动服务**:
   ```bash
   # 重新加载systemd配置
   sudo systemctl daemon-reload
   
   # 启用并启动服务
   sudo systemctl enable hrms
   sudo systemctl start hrms
   
   # 检查服务状态
   sudo systemctl status hrms
   ```

#### 容器化部署

**Docker部署方式**:

1. 创建Dockerfile:
   ```dockerfile
   # 多阶段构建
   FROM golang:1.18-alpine AS builder
   
   WORKDIR /app
   COPY go.mod go.sum ./
   RUN go mod download
   
   COPY . .
   RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o hrms main.go
   
   # 运行阶段
   FROM alpine:latest
   
   WORKDIR /root/
   
   # 安装必要工具
   RUN apk --no-cache add ca-certificates tzdata
   WORKDIR /root/
   
   # 复制编译好的二进制文件
   COPY --from=builder /app/hrms .
   
   # 复制静态资源和配置文件
   COPY --from=builder /app/static ./static
   COPY --from=builder /app/views ./views
   COPY --from=builder /app/config ./config
   
   # 创建非root用户
   RUN addgroup -g 1001 -S hrms
   RUN adduser -S hrms -u 1001
   USER hrms
   
   # 暴露端口
   EXPOSE 8080
   
   # 启动应用
   CMD ["./hrms"]
   ```

2. 构建Docker镜像:
   ```bash
   docker build -t hrms:latest .
   ```

3. 运行Docker容器:
   ```bash
   docker run -d \
       --name hrms \
       -p 8080:8080 \
       -v $(pwd)/data:/root/data \
       -v $(pwd)/logs:/root/logs \
       -e HRMS_ENV=prod \
       hrms:latest
   ```

**Docker Compose部署方式**:

1. 创建docker-compose.yml文件:
   ```yaml
   version: '3.8'
   
   services:
     hrms:
       build: .
       ports:
         - "8080:8080"
       environment:
         - HRMS_ENV=prod
       volumes:
         - ./data:/root/data
         - ./logs:/root/logs
         - ./config:/root/config
       depends_on:
         - mysql
       restart: unless-stopped
     
     mysql:
       image: mysql:8.0
       environment:
         MYSQL_ROOT_PASSWORD: root-password
         MYSQL_DATABASE: hrms_production
         MYSQL_USER: hrms_user
         MYSQL_PASSWORD: secure-password
       ports:
         - "3306:3306"
       volumes:
         - mysql_data:/var/lib/mysql
         - ./sql/init:/docker-entrypoint-initdb.d
       restart: unless-stopped
     
     nginx:
       image: nginx:alpine
       ports:
         - "80:80"
         - "443:443"
       volumes:
         - ./nginx/nginx.conf:/etc/nginx/nginx.conf
         - ./nginx/ssl:/etc/nginx/ssl
       depends_on:
         - hrms
       restart: unless-stopped
   
   volumes:
     mysql_data:
   ```

2. 启动服务:
   ```bash
   docker-compose up -d
   ```

### 4.4 负载均衡与高可用配置

#### Nginx配置

1. **安装Nginx**:
   ```bash
   # CentOS/RHEL
   sudo yum install -y nginx
   sudo systemctl start nginx
   sudo systemctl enable nginx
   
   # Ubuntu/Debian
   sudo apt-get install -y nginx
   sudo systemctl start nginx
   sudo systemctl enable nginx
   ```

2. **配置HRMS应用**:
   创建`/etc/nginx/conf.d/hrms.conf`:
   ```nginx
   server {
       listen 80;
       server_name example.com;
       
       # 配置HTTP到HTTPS重定向
       return 301 https://$server_name$request_uri;
   }
   
   server {
       listen 443 ssl http2;
       server_name example.com;
       
       # SSL证书配置
       ssl_certificate /etc/nginx/ssl/cert.pem;
       ssl_certificate_key /etc/nginx/ssl/key.pem;
       ssl_protocols TLSv1.2 TLSv1.3;
       ssl_ciphers HIGH:!aNULL:!MD5;
       
       # 静态文件处理
       location /static/ {
           alias /opt/hrms/static/;
           expires 1y;
           add_header Cache-Control "public, immutable";
       }
       
       # API请求代理到后端
       location /api/ {
           proxy_pass http://127.0.0.1:8080;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
       
       # 默认请求处理
       location / {
           proxy_pass http://127.0.0.1:8080;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
   }
   ```

#### 负载均衡配置

多实例部署时的负载均衡配置：

```nginx
upstream hrms_backend {
    server 127.0.0.1:8080 weight=1 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:8081 weight=1 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:8082 weight=1 max_fails=3 fail_timeout=30s;
}

server {
    listen 443 ssl http2;
    server_name example.com;
    
    # SSL配置...
    
    location / {
        proxy_pass http://hrms_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 5. 构建工具使用

### 5.1 构建脚本功能详解

#### 基础构建命令

```bash
# 构建当前平台可执行文件
bash build.sh build

# 构建所有平台的可执行文件
bash build.sh build-all

# 清理构建文件
bash build.sh clean
```

#### 运行模式控制

```bash
# 开发模式运行
bash build.sh run-dev

# 生产模式运行
bash build.sh run-prod

# 自定义配置运行
bash build.sh run-self
```

#### 代码质量保证

```bash
# 代码格式化
bash build.sh fmt

# 静态代码检查
bash build.sh vet

# 综合代码检查
bash build.sh lint

# 安全检查
bash build.sh security
```

### 5.2 高级功能

#### 数据库管理

```bash
# 运行数据库迁移
bash build.sh migrate

# 重置数据库
bash build.sh migrate-reset

# 针对特定分公司数据库操作
bash build.sh migrate-db hrms_C001
bash build.sh migrate-reset-db hrms_C001

# 创建新分公司数据库
bash build.sh createdb hrms_C003
```

#### 容器化部署

```bash
# 构建Docker镜像
bash build.sh docker-build

# 运行Docker容器
bash build.sh docker-run

# 停止Docker容器
bash build.sh docker-stop
```

### 5.3 环境变量配置

构建脚本支持通过环境变量自定义行为：

```bash
# 设置运行环境
ENV=prod bash build.sh run-prod

# 设置服务端口
PORT=9000 bash build.sh run-dev

# 组合使用
ENV=prod PORT=9000 bash build.sh run-prod
```

### 5.4 多分公司部署策略

使用构建脚本进行多分公司部署的完整流程：

```bash
# 1. 创建多个分公司数据库
bash build.sh createdb hrms_C001,hrms_C002,hrms_C003

# 2. 运行数据库迁移到所有分公司
bash build.sh migrate-db hrms_C001
bash build.sh migrate-db hrms_C002
bash build.sh migrate-db hrms_C003

# 3. 构建生产版本
bash build.sh build

# 4. 创建部署包
bash build.sh package

# 5. 部署到生产环境
# 将dist目录中的压缩包分发到目标服务器并解压运行
```

### 5.5 监控与告警

#### 应用性能监控

HRMS系统支持集成Prometheus和Grafana进行性能监控：

1. **添加Prometheus指标**:
   ```go
   // 在main.go中添加Prometheus指标
   import "github.com/prometheus/client_golang/prometheus"
   import "github.com/prometheus/client_golang/prometheus/promhttp"
   
   var (
       httpRequestsTotal = prometheus.NewCounterVec(
           prometheus.CounterOpts{
               Name: "http_requests_total",
               Help: "Total number of HTTP requests",
           },
           []string{"method", "path", "status"},
       )
       
       httpRequestDuration = prometheus.NewHistogramVec(
           prometheus.HistogramOpts{
               Name: "http_request_duration_seconds",
               Help: "HTTP request duration in seconds",
               Buckets: prometheus.DefBuckets,
           },
           []string{"method", "path"},
       )
   )
   
   func init() {
       prometheus.MustRegister(httpRequestsTotal)
       prometheus.MustRegister(httpRequestDuration)
   }
   
   // 添加指标中间件
   func metricsMiddleware() gin.HandlerFunc {
       return func(c *gin.Context) {
           start := time.Now()
           
           c.Next()
           
           duration := time.Since(start).Seconds()
           status := strconv.Itoa(c.Writer.Status())
           
           httpRequestsTotal.WithLabelValues(c.Request.Method, c.FullPath(), status).Inc()
           httpRequestDuration.WithLabelValues(c.Request.Method, c.FullPath()).Observe(duration)
       }
   }
   
   // 在路由中添加指标端点
   func setupRoutes() *gin.Engine {
       r := gin.Default()
       r.Use(metricsMiddleware())
       
       // 添加Prometheus指标端点
       r.GET("/metrics", gin.WrapH(promhttp.Handler()))
       
       // 其他路由...
       return r
   }
   ```

2. **配置Prometheus**:
   创建`prometheus.yml`配置文件：
   ```yaml
   global:
     scrape_interval: 15s
     
   scrape_configs:
     - job_name: 'hrms'
       static_configs:
         - targets: ['localhost:8080']
       metrics_path: '/metrics'
   ```

3. **配置Grafana仪表板**:
   ```json
   {
     "dashboard": {
       "title": "HRMS系统监控",
       "panels": [
         {
           "title": "HTTP请求率",
           "type": "graph",
           "targets": [
             {
               "expr": "rate(http_requests_total[5m])",
               "legendFormat": "{{method}} {{path}}"
             }
           ]
         },
         {
           "title": "请求响应时间",
           "type": "graph",
           "targets": [
             {
               "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))",
               "legendFormat": "95th percentile"
             }
           ]
         }
       ]
     }
   }
   ```

#### 日志管理

1. **配置结构化日志**:
   ```go
   import "github.com/sirupsen/logrus"
   
   func initLogger() {
       log := logrus.New()
       
       // 设置日志格式为JSON
       log.SetFormatter(&logrus.JSONFormatter{})
       
       // 设置日志级别
       log.SetLevel(logrus.InfoLevel)
       
       // 设置日志输出
       log.SetOutput(os.Stdout)
   }
   
   // 在处理器中使用日志
   func HandleStaffList(c *gin.Context) {
       log := logrus.WithFields(logrus.Fields{
           "user_id": getUserID(c),
           "action": "list_staff",
       })
       
       log.Info("开始获取员工列表")
       
       staff, err := service.GetAllStaff(c)
       if err != nil {
           log.WithError(err).Error("获取员工列表失败")
           c.JSON(http.StatusInternalServerError, gin.H{
               "success": false,
               "message": "获取员工列表失败",
           })
           return
       }
       
       log.Info("成功获取员工列表")
       c.JSON(http.StatusOK, gin.H{
           "success": true,
           "data": staff,
       })
   }
   ```

2. **配置ELK Stack进行日志聚合**:
   - Elasticsearch: 存储和索引日志数据
   - Logstash: 处理和转换日志数据
   - Kibana: 可视化和分析日志数据

3. **配置Filebeat进行日志收集**:
   ```yaml
   # filebeat.yml
   filebeat.inputs:
   - type: log
     enabled: true
     paths:
       - /var/log/hrms/*.log
     fields:
       service: hrms
       environment: production
     
   output.elasticsearch:
     hosts: ["elasticsearch:9200"]
     index: "hrms-logs-%{+yyyy.MM.dd}"
   ```

#### 告警配置

1. **配置Alertmanager**:
   ```yaml
   # alertmanager.yml
   global:
     smtp_smarthost: 'your-smtp-server:587'
     smtp_from: 'alerts@example.com'
     
   route:
     group_by: ['alertname']
     group_wait: 10s
     group_interval: 10s
     repeat_interval: 1h
     receiver: 'web.hook'
     
   receivers:
   - name: 'web.hook'
     email_configs:
     - to: 'admin@example.com'
       subject: '[HRMS Alert] {{ .GroupLabels.alertname }}'
       body: |
         {{ range .Alerts }}
         Alert: {{ .Annotations.summary }}
         Description: {{ .Annotations.description }}
         {{ end }}
   ```

2. **配置Prometheus告警规则**:
   ```yaml
   # alert_rules.yml
   groups:
   - name: hrms_alerts
     rules:
     - alert: HighErrorRate
       expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.1
       for: 5m
       labels:
         severity: critical
       annotations:
         summary: "High error rate detected"
         description: "Error rate is above 10% for more than 5 minutes"
         
     - alert: HighResponseTime
       expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 2
       for: 5m
       labels:
         severity: warning
       annotations:
         summary: "High response time detected"
         description: "95th percentile response time is above 2 seconds"
   ```

### 5.6 备份与恢复策略

#### 数据库备份

1. **MySQL备份脚本**:
   ```bash
   #!/bin/bash
   # backup-mysql.sh
   
   BACKUP_DIR="/opt/backups/mysql"
   DATE=$(date +%Y%m%d_%H%M%S)
   DB_NAME="hrms_production"
   DB_USER="hrms_user"
   DB_PASS="secure-password"
   
   # 创建备份目录
   mkdir -p $BACKUP_DIR
   
   # 执行备份
   mysqldump -u$DB_USER -p$DB_PASS --single-transaction --routines --triggers $DB_NAME > $BACKUP_DIR/hrms_backup_$DATE.sql
   
   # 压缩备份文件
   gzip $BACKUP_DIR/hrms_backup_$DATE.sql
   
   # 删除7天前的备份
   find $BACKUP_DIR -name "hrms_backup_*.sql.gz" -mtime +7 -delete
   
   echo "备份完成: $BACKUP_DIR/hrms_backup_$DATE.sql.gz"
   ```

2. **SQLite备份脚本**:
   ```bash
   #!/bin/bash
   # backup-sqlite.sh
   
   BACKUP_DIR="/opt/backups/sqlite"
   DATE=$(date +%Y%m%d_%H%M%S)
   SOURCE_DB="/data/hrms_C001.db"
   
   # 创建备份目录
   mkdir -p $BACKUP_DIR
   
   # 复制数据库文件
   cp $SOURCE_DB $BACKUP_DIR/hrms_C001_backup_$DATE.db
   
   # 压缩备份文件
   gzip $BACKUP_DIR/hrms_C001_backup_$DATE.db
   
   # 删除7天前的备份
   find $BACKUP_DIR -name "hrms_C001_backup_*.db.gz" -mtime +7 -delete
   
   echo "备份完成: $BACKUP_DIR/hrms_C001_backup_$DATE.db.gz"
   ```

3. **设置定时备份**:
   ```bash
   # 添加到crontab
   crontab -e
   
   # 每天凌晨2点执行MySQL备份
   0 2 * * * /opt/scripts/backup-mysql.sh >> /var/log/backup.log 2>&1
   
   # 每天凌晨3点执行SQLite备份
   0 3 * * * /opt/scripts/backup-sqlite.sh >> /var/log/backup.log 2>&1
   ```

#### 应用备份

1. **应用文件备份脚本**:
   ```bash
   #!/bin/bash
   # backup-app.sh
   
   BACKUP_DIR="/opt/backups/app"
   DATE=$(date +%Y%m%d_%H%M%S)
   APP_DIR="/opt/hrms"
   
   # 创建备份目录
   mkdir -p $BACKUP_DIR
   
   # 创建应用备份
   tar -czf $BACKUP_DIR/hrms_app_backup_$DATE.tar.gz -C $APP_DIR .
   
   # 删除30天前的备份
   find $BACKUP_DIR -name "hrms_app_backup_*.tar.gz" -mtime +30 -delete
   
   echo "应用备份完成: $BACKUP_DIR/hrms_app_backup_$DATE.tar.gz"
   ```

#### 数据恢复

1. **MySQL数据恢复**:
   ```bash
   # 恢复MySQL数据库
   gunzip < /opt/backups/mysql/hrms_backup_20231201_020000.sql.gz | mysql -uhrms_user -p hrms_production
   ```

2. **SQLite数据恢复**:
   ```bash
   # 恢复SQLite数据库
   gunzip -c /opt/backups/sqlite/hrms_C001_backup_20231201_030000.db.gz > /data/hrms_C001.db
   ```

3. **应用恢复**:
   ```bash
   # 恢复应用文件
   tar -xzf /opt/backups/app/hrms_app_backup_20231201_010000.tar.gz -C /opt/hrms
   
   # 重启应用服务
   sudo systemctl restart hrms
   ```

### 5.7 灾难恢复计划

#### 恢复流程

1. **评估灾难影响**:
   - 确定受影响的系统组件
   - 评估数据丢失程度
   - 确定恢复优先级

2. **执行恢复步骤**:
   - 恢复基础设施（服务器、网络）
   - 恢复数据库系统
   - 恢复应用系统
   - 恢复配置文件
   - 验证系统功能

3. **验证恢复结果**:
   - 执行系统健康检查
   - 验证关键业务功能
   - 进行性能测试
   - 通知相关方系统已恢复

#### 恢复时间目标(RTO)和恢复点目标(RPO)

| 系统 | RTO | RPO |
|------|-----|-----|
| 数据库 | 2小时 | 1小时 |
| 应用服务器 | 1小时 | 4小时 |
| 网络设备 | 30分钟 | 15分钟 |

### 5.8 性能优化

#### 数据库优化

1. **索引优化**:
   ```sql
   -- 为常用查询创建索引
   CREATE INDEX idx_staff_company ON staff(company_id);
   CREATE INDEX idx_attendance_date ON attendance_record(date);
   CREATE INDEX idx_salary_month ON salary_detail(month);
   ```

2. **查询优化**:
   - 使用EXPLAIN分析查询执行计划
   - 避免SELECT *，只查询需要的字段
   - 使用适当的JOIN类型
   - 避免在WHERE子句中使用函数

3. **连接池配置**:
   ```go
   // 配置GORM连接池
   db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{})
   if err != nil {
       log.Fatal("连接数据库失败:", err)
   }
   
   sqlDB, err := db.DB()
   if err != nil {
       log.Fatal("获取底层数据库连接失败:", err)
   }
   
   // 设置连接池参数
   sqlDB.SetMaxIdleConns(10)     // 最大空闲连接数
   sqlDB.SetMaxOpenConns(100)    // 最大打开连接数
   sqlDB.SetConnMaxLifetime(time.Hour) // 连接最大存活时间
   ```

#### 应用优化

1. **缓存策略**:
   ```go
   import "github.com/go-redis/redis/v8"
   
   // 初始化Redis客户端
   rdb := redis.NewClient(&redis.Options{
       Addr:     "localhost:6379",
       Password: "",
       DB:       0,
   })
   
   // 缓存员工信息
   func GetStaffByID(id string) (*model.Staff, error) {
       // 先从缓存获取
       cached, err := rdb.Get(ctx, "staff:"+id).Result()
       if err == nil {
           var staff model.Staff
           json.Unmarshal([]byte(cached), &staff)
           return &staff, nil
       }
       
       // 缓存未命中，从数据库获取
       staff, err := model.GetStaffByID(id)
       if err != nil {
           return nil, err
       }
       
       // 将结果存入缓存，设置过期时间为1小时
       staffJSON, _ := json.Marshal(staff)
       rdb.Set(ctx, "staff:"+id, staffJSON, time.Hour)
       
       return staff, nil
   }
   ```

2. **并发控制**:
   ```go
   import "sync"
   
   var (
       staffCache = make(map[string]*model.Staff)
       cacheMutex sync.RWMutex
   )
   
   func GetStaffByIDCached(id string) (*model.Staff, error) {
       // 使用读锁检查缓存
       cacheMutex.RLock()
       staff, exists := staffCache[id]
       cacheMutex.RUnlock()
       
       if exists {
           return staff, nil
       }
       
       // 缓存未命中，使用写锁更新缓存
       cacheMutex.Lock()
       defer cacheMutex.Unlock()
       
       // 双重检查，防止并发更新
       staff, exists = staffCache[id]
       if exists {
           return staff, nil
       }
       
       // 从数据库获取并更新缓存
       staff, err := model.GetStaffByID(id)
       if err != nil {
           return nil, err
       }
       
       staffCache[id] = staff
       return staff, nil
   }
   ```

3. **内存优化**:
   ```go
   // 使用对象池减少内存分配
   var staffPool = sync.Pool{
       New: func() interface{} {
           return new(model.Staff)
       },
   }
   
   func ProcessStaffData() {
       // 从对象池获取对象
       staff := staffPool.Get().(*model.Staff)
       defer func() {
           // 重置对象并放回池中
           *staff = model.Staff{}
           staffPool.Put(staff)
       }()
       
       // 使用对象处理数据
       // ...
   }
   ```

### 5.9 安全加固

#### 应用安全

1. **密码策略**:
   ```go
   import (
       "golang.org/x/crypto/bcrypt"
       "regexp"
   )
   
   // 密码强度验证
   func validatePassword(password string) error {
       if len(password) < 8 {
           return errors.New("密码长度至少为8位")
       }
       
       // 检查是否包含大写字母
       if matched, _ := regexp.MatchString("[A-Z]", password); !matched {
           return errors.New("密码必须包含至少一个大写字母")
       }
       
       // 检查是否包含小写字母
       if matched, _ := regexp.MatchString("[a-z]", password); !matched {
           return errors.New("密码必须包含至少一个小写字母")
       }
       
       // 检查是否包含数字
       if matched, _ := regexp.MatchString("[0-9]", password); !matched {
           return errors.New("密码必须包含至少一个数字")
       }
       
       // 检查是否包含特殊字符
       if matched, _ := regexp.MatchString("[!@#$%^&*()_+{}|:<>?]", password); !matched {
           return errors.New("密码必须包含至少一个特殊字符")
       }
       
       return nil
   }
   
   // 密码加密
   func hashPassword(password string) (string, error) {
       bytes, err := bcrypt.GenerateFromPassword([]byte(password), bcrypt.DefaultCost)
       return string(bytes), err
   }
   
   // 密码验证
   func checkPasswordHash(password, hash string) bool {
       err := bcrypt.CompareHashAndPassword([]byte(hash), []byte(password))
       return err == nil
   }
   ```

2. **会话管理**:
   ```go
   import (
       "crypto/rand"
       "encoding/base64"
       "time"
   )
   
   // 生成安全随机令牌
   func generateSecureToken(length int) string {
       b := make([]byte, length)
       _, err := rand.Read(b)
       if err != nil {
           log.Fatal("生成安全令牌失败:", err)
       }
       return base64.URLEncoding.EncodeToString(b)
   }
   
   // 设置安全的Cookie
   func setSecureCookie(c *gin.Context, name, value string) {
       // 设置HttpOnly防止XSS攻击
       // 设置Secure确保只通过HTTPS传输
       // 设置SameSite防止CSRF攻击
       c.SetCookie(name, value, 3600, "/", "", true, true)
   }
   
   // 会话中间件
   func sessionMiddleware() gin.HandlerFunc {
       return func(c *gin.Context) {
           cookie, err := c.Cookie("hrms_session")
           if err != nil {
               // 未登录用户重定向到登录页面
               c.Redirect(302, "/login")
               c.Abort()
               return
           }
           
           // 验证会话有效性
           if !validateSession(cookie) {
               c.SetCookie("hrms_session", "", -1, "/", "", true, true)
               c.Redirect(302, "/login")
               c.Abort()
               return
           }
           
           // 更新会话过期时间
           if shouldRefreshSession(cookie) {
               newToken := generateSecureToken(32)
               setSecureCookie(c, "hrms_session", newToken)
               updateSessionInDB(cookie, newToken)
           }
           
           c.Next()
       }
   }
   ```

3. **CSRF防护**:
   ```go
   import (
       "crypto/subtle"
       "net/http"
   )
   
   // CSRF令牌生成和验证
   func generateCSRFToken() string {
       return generateSecureToken(32)
   }
   
   // CSRF中间件
   func csrfMiddleware() gin.HandlerFunc {
       return func(c *gin.Context) {
           // 对于GET请求跳过CSRF检查
           if c.Request.Method == "GET" {
               c.Next()
               return
           }
           
           // 获取请求头中的令牌
           headerToken := c.GetHeader("X-CSRF-Token")
           
           // 获取表单中的令牌
           formToken := c.PostForm("_csrf")
           
           // 获取Cookie中的令牌
           cookieToken, err := c.Cookie("csrf_token")
           if err != nil {
               http.Error(c.Writer, "CSRF令牌缺失", http.StatusForbidden)
               c.Abort()
               return
           }
           
           // 验证令牌
           var requestToken string
           if headerToken != "" {
               requestToken = headerToken
           } else if formToken != "" {
               requestToken = formToken
           } else {
               http.Error(c.Writer, "CSRF令牌缺失", http.StatusForbidden)
               c.Abort()
               return
           }
           
           // 使用时间恒定比较防止时序攻击
           if subtle.ConstantTimeCompare([]byte(requestToken), []byte(cookieToken)) != 1 {
               http.Error(c.Writer, "CSRF令牌无效", http.StatusForbidden)
               c.Abort()
               return
           }
           
           c.Next()
       }
   }
   ```

4. **SQL注入防护**:
   ```go
   // 使用参数化查询防止SQL注入
   func GetStaffByDepartment(departmentID string) ([]model.Staff, error) {
       var staff []model.Staff
       
       // 使用GORM的参数化查询
       result := db.Where("department_id = ?", departmentID).Find(&staff)
       if result.Error != nil {
           return nil, result.Error
       }
       
       return staff, nil
   }
   
   // 对于原生SQL，也使用参数化查询
   func GetStaffByRawSQL(departmentID string) ([]model.Staff, error) {
       var staff []model.Staff
       
       // 使用?作为参数占位符
       query := "SELECT * FROM staff WHERE department_id = ?"
       result := db.Raw(query, departmentID).Scan(&staff)
       if result.Error != nil {
           return nil, result.Error
       }
       
       return staff, nil
   }
   ```

5. **XSS防护**:
   ```go
   import (
       "html"
       "strings"
   )
   
   // 输出转义
   func escapeOutput(input string) string {
       return html.EscapeString(input)
   }
   
   // 输入验证
   func sanitizeInput(input string) string {
       // 移除潜在的脚本标签
       scriptPattern := regexp.MustCompile(`(?i)<script.*?>.*?</script>`)
       input = scriptPattern.ReplaceAllString(input, "")
       
       // 移除危险的HTML属性
       dangerousAttrs := []string{"onload", "onerror", "onclick", "onmouseover"}
       for _, attr := range dangerousAttrs {
           pattern := regexp.MustCompile(`(?i)\s` + attr + `\s*=\s*["'][^"']*["']`)
           input = pattern.ReplaceAllString(input, "")
       }
       
       return input
   }
   
   // 内容安全策略(CSP)中间件
   func cspMiddleware() gin.HandlerFunc {
       return func(c *gin.Context) {
           // 设置CSP头，限制资源加载来源
           c.Header("Content-Security-Policy",
               "default-src 'self'; " +
               "script-src 'self' 'unsafe-inline'; " +
               "style-src 'self' 'unsafe-inline'; " +
               "img-src 'self' data:; " +
               "font-src 'self'; " +
               "connect-src 'self'")
           c.Next()
       }
   }
   ```

#### 网络安全

1. **HTTPS配置**:
   ```nginx
   server {
       listen 443 ssl http2;
       server_name hrms.example.com;
       
       # SSL证书配置
       ssl_certificate /etc/ssl/certs/hrms.crt;
       ssl_certificate_key /etc/ssl/private/hrms.key;
       
       # SSL安全配置
       ssl_protocols TLSv1.2 TLSv1.3;
       ssl_prefer_server_ciphers on;
       ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
       ssl_session_timeout 10m;
       ssl_session_cache shared:SSL:10m;
       
       # HSTS头，强制HTTPS
       add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
       
       # 其他安全头
       add_header X-Frame-Options DENY;
       add_header X-Content-Type-Options nosniff;
       add_header X-XSS-Protection "1; mode=block";
       add_header Referrer-Policy "strict-origin-when-cross-origin";
   }
   ```

2. **防火墙配置**:
   ```bash
   # CentOS/RHEL使用firewalld
   sudo firewall-cmd --permanent --add-service=http
   sudo firewall-cmd --permanent --add-service=https
   sudo firewall-cmd --permanent --add-port=3306/tcp  # MySQL端口，仅限内部访问
   sudo firewall-cmd --reload
   
   # Ubuntu/Debian使用UFW
   sudo ufw allow 80/tcp    # HTTP
   sudo ufw allow 443/tcp   # HTTPS
   sudo ufw allow from 10.0.0.0/8 to any port 3306  # MySQL，仅限内网
   sudo ufw enable
   ```

### 5.10 故障排除

#### 常见问题诊断

1. **应用无法启动**:
   ```bash
   # 检查应用日志
   sudo journalctl -u hrms -f
   
   # 检查配置文件
   cat /opt/hrms/config/config-prod.yaml
   
   # 检查端口占用
   sudo netstat -tlnp | grep 8080
   
   # 检查数据库连接
   mysql -u hrms_user -p -h localhost hrms_production
   ```

2. **数据库连接问题**:
   ```bash
   # 检查MySQL服务状态
   sudo systemctl status mysql
   
   # 检查MySQL日志
   sudo tail -f /var/log/mysql/error.log
   
   # 测试数据库连接
   mysql -u hrms_user -p -h localhost hrms_production -e "SELECT 1"
   
   # 检查数据库用户权限
   mysql -u root -p -e "SHOW GRANTS FOR 'hrms_user'@'%'"
   ```

3. **性能问题**:
   ```bash
   # 检查系统资源使用
   top
   htop
   iotop
   
   # 检查数据库性能
   mysql -u root -p -e "SHOW PROCESSLIST"
   mysql -u root -p -e "SHOW FULL PROCESSLIST"
   
   # 检查慢查询
   mysql -u root -p -e "SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 10"
   ```

#### 日志分析

1. **应用日志分析**:
   ```bash
   # 查看错误日志
   grep -i error /var/log/hrms/hrms.log
   
   # 查看特定时间范围的日志
   grep "2023-12-01 10:" /var/log/hrms/hrms.log
   
   # 统计错误类型
   grep -i error /var/log/hrms/hrms.log | awk '{print $NF}' | sort | uniq -c
   
   # 分析请求响应时间
   grep "request completed" /var/log/hrms/hrms.log | awk '{print $NF}' | sort -n
   ```

2. **Nginx日志分析**:
   ```bash
   # 查看访问日志
   tail -f /var/log/nginx/hrms_access.log
   
   # 查看错误日志
   tail -f /var/log/nginx/hrms_error.log
   
   # 统计HTTP状态码
   awk '{print $9}' /var/log/nginx/hrms_access.log | sort | uniq -c
   
   # 查看Top 10访问IP
   awk '{print $1}' /var/log/nginx/hrms_access.log | sort | uniq -c | sort -nr | head -10
   
   # 查看响应时间最长的请求
   awk '{print $NF, $7}' /var/log/nginx/hrms_access.log | sort -nr | head -10
   ```

#### 故障恢复流程

1. **服务重启**:
   ```bash
   # 重启HRMS应用
   sudo systemctl restart hrms
   sudo systemctl status hrms
   
   # 重启数据库
   sudo systemctl restart mysql
   sudo systemctl status mysql
   
   # 重启Nginx
   sudo systemctl restart nginx
   sudo systemctl status nginx
   ```

2. **数据恢复**:
   ```bash
   # 从备份恢复数据库
   gunzip < /opt/backups/mysql/hrms_backup_latest.sql.gz | mysql -u hrms_user -p hrms_production
   
   # 恢复配置文件
   cp /opt/backups/config/config-prod.yaml.backup /opt/hrms/config/config-prod.yaml
   
   # 重启服务
   sudo systemctl restart hrms
   ```

3. **紧急故障处理**:
   ```bash
   # 快速回滚到上一个版本
   cd /opt/hrms
   git checkout previous_version_tag
   go build -o hrms main.go
   sudo systemctl restart hrms
   
   # 如果回滚失败，切换到备用服务器
   # 1. 更新DNS指向备用服务器
   # 2. 在备用服务器上启动服务
   # 3. 通知用户系统已切换到备用环境
   ```

### 5.11 最佳实践总结

#### 开发最佳实践

1. **代码质量**:
   - 使用静态分析工具检查代码质量
   - 定期进行代码审查
   - 保持高测试覆盖率
   - 遵循项目编码规范

2. **版本控制**:
   - 使用语义化版本控制
   - 编写清晰的提交信息
   - 使用分支策略管理开发流程
   - 定期合并主分支的更新

#### 运维最佳实践

1. **监控与告警**:
   - 建立全面的监控体系
   - 设置合理的告警阈值
   - 定期检查和更新监控规则
   - 建立有效的告警响应流程

2. **备份与恢复**:
   - 定期执行备份并验证备份有效性
   - 测试恢复流程确保可用性
   - 建立异地备份机制
   - 定期进行灾难恢复演练

3. **安全防护**:
   - 定期更新系统和依赖库
   - 进行安全漏洞扫描
   - 实施最小权限原则
   - 定期进行安全审计

#### 性能优化最佳实践

1. **数据库优化**:
   - 合理设计索引
   - 避免N+1查询问题
   - 使用连接池管理数据库连接
   - 定期进行数据库维护

2. **应用优化**:
   - 使用缓存减少数据库访问
   - 优化算法和数据结构
   - 实现异步处理机制
   - 进行性能测试和调优

通过遵循这些最佳实践，可以确保HRMS系统的稳定运行，提高开发效率，减少运维成本，并为用户提供更好的服务体验。

## 3. 测试策略

### 3.1 测试层次

HRMS系统采用多层次测试策略，确保代码质量和系统稳定性：

1. **单元测试**: 针对单个函数或方法的测试
2. **集成测试**: 测试组件之间的交互
3. **端到端测试**: 模拟真实用户场景的测试

### 3.2 多分公司测试策略

由于HRMS系统采用多分公司数据隔离架构，测试需要特别注意数据隔离和数据库切换的正确验证：

#### 测试数据库切换机制

```go
// 测试数据库切换功能
func TestDynamicDBSwitching(t *testing.T) {
    // 创建测试环境
    gin.SetMode(gin.TestMode)
    
    // 准备多个测试数据库
    testDatabases := map[string]*gorm.DB{
        "C001": createTestDB(t, "hrms_test_C001"),
        "C002": createTestDB(t, "hrms_test_C002"),
    }
    
    // 模拟HTTP请求
    w := httptest.NewRecorder()
    c, _ := gin.CreateTestContext(w)
    
    // 设置不同公司的Cookie
    tests := []struct {
        name      string
        cookie    string
        expectedDB string
    }{
        {"C001公司Cookie", "supersys_admin001_C001_admin", "hrms_test_C001"},
        {"C002公司Cookie", "sys_hr002_C002_hradmin", "hrms_test_C002"},
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // 设置Cookie
            c.Request = &http.Request{
                Header: http.Header{"Cookie": []string{"hrms_session=" + tt.cookie}},
            }
            
            // 获取数据库连接
            db := resource.HrmsDB(c)
            
            // 验证连接到正确的数据库
            var result struct {
                Database string
            }
            db.Raw("SELECT database()").Scan(&result)
            assert.Contains(t, result.Database, tt.expectedDB)
        })
    }
}
```

### 3.2 单元测试

#### 测试框架

HRMS使用Go内置的`testing`包进行单元测试，可配合使用`testify`等扩展库增强测试能力。

#### 测试编写规范

```go
// model/model_test.go
package model

import (
    "testing"
    "time"
    "github.com/stretchr/testify/assert"
)

// TestCreateStaff 测试员工创建功能
func TestCreateStaff(t *testing.T) {
    // 准备测试数据
    staff := &Staff{
        StaffID:     "TEST001",
        StaffName:   "测试员工",
        Birthday:    time.Now(),
        IdentityNum: "123456789012345678",
        // 其他字段...
    }

    // 执行测试
    result, err := CreateStaff(staff)

    // 验证结果
    assert.NoError(t, err)
    assert.NotNil(t, result)
    assert.Equal(t, "TEST001", result.StaffID)
    assert.Equal(t, "测试员工", result.StaffName)
}

// TestValidateStaffEmail 测试邮箱验证（表驱动测试）
func TestValidateStaffEmail(t *testing.T) {
    testCases := []struct {
        name     string
        email    string
        expected bool
    }{
        {"有效邮箱", "user@example.com", true},
        {"无效邮箱-缺少@", "userexample.com", false},
        {"无效邮箱-缺少域名", "user@", false},
        {"空邮箱", "", false},
    }

    for _, tc := range testCases {
        t.Run(tc.name, func(t *testing.T) {
            result := ValidateStaffEmail(tc.email)
            assert.Equal(t, tc.expected, result)
        })
    }
}
```

#### 模拟依赖

```go
// 使用testify模拟数据库操作
import (
    "testing"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"
    "gorm.io/gorm"
)

// MockDB 模拟数据库
type MockDB struct {
    mock.Mock
}

func (m *MockDB) Create(value interface{}) *gorm.DB {
    args := m.Called(value)
    return args.Get(0).(*gorm.DB)
}

// 使用模拟数据库测试服务层
func TestStaffService_CreateStaff(t *testing.T) {
    // 创建模拟数据库
    mockDB := new(MockDB)
    
    // 设置期望
    mockDB.On("Create", mock.AnythingOfType("*model.Staff")).Return(&gorm.DB{
        Error: nil,
    })
    
    // 创建服务并注入模拟依赖
    service := &StaffService{db: mockDB}
    
    // 测试数据
    staff := &Staff{
        StaffID:   "TEST001",
        StaffName: "测试员工",
    }
    
    // 执行测试
    err := service.CreateStaff(staff)
    
    // 验证
    assert.NoError(t, err)
    mockDB.AssertExpectations(t)
}
```

### 3.3 集成测试

#### 数据库测试

```go
// integration_test.go
package tests

import (
    "testing"
    "path/filepath"
    "github.com/stretchr/testify/assert"
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
    "your-project/model"
)

// setupTestDB 创建测试数据库
func setupTestDB(t *testing.T) *gorm.DB {
    // 使用内存SQLite数据库
    db, err := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{})
    assert.NoError(t, err)
    
    // 自动迁移
    err = db.AutoMigrate(&model.Staff{}, &model.Department{})S E C R E T } 
 
     m a x a g e :   3 6 0 0 
 
 
 
 m o d e :   r e l e a s e 
 
 ` ` ` 
 
 
 
 # # # #   ��h�Y�@jzV���]�u
 
 
 
 cm�de��h�Y�@jzVUt�U
m���_�R���]�u�? 
 
 
 
 ` ` ` b a s h 
 
 #   "��q����h�tgR�u
 
 e x p o r t   D B _ P A S S W O R D = " y o u r - s e c u r e - p a s s w o r d " 
 
 e x p o r t   S E S S I O N _ S E C R E T = " y o u r - s e c u r e - s e s s i o n - s e c r e t " 
 
 e x p o r t   H R M S _ E N V = p r o d 
 
 ` ` ` 
 
 
 
 # # #   4 . 2   "��q����h�Q��U,�
 
 
 
 # # # #   ȓ�]�Yc�(1���Y? 
 
 
 
 * * ȓ� cm�^�S? * �? 
 
 -   C P U :   2 ͓? 
 
 -   P�mT�t:   4 G B 
 
 -   p:jMP:   5 0 G B   S S D 
 
 -    b�|:   1 0 0 M b p s 
 
 
 
 * * ��(1]���]�u* * �? 
 
 -   C P U :   4 ͓? 
 
 -   P�mT�t:   8 G B + 
 
 -   p:jMP:   1 0 0 G B +   S S D 
 
 -    b�|:   1 G b p s 
 
 
 
 # # # #   �~d��|n�o�y9pY��
 
 
 
 ` ` ` b a s h 
 
 #   C e n t O S / R H E L 
 
 s u d o   y u m   u p d a t e   - y 
 
 s u d o   y u m   i n s t a l l   - y   g i t   w g e t   c u r l 
 
 
 
 #   U b u n t u / D e b i a n 
 
 s u d o   a p t - g e t   u p d a t e   - y 
 
 s u d o   a p t - g e t   i n s t a l l   - y   g i t   w g e t   c u r l 
 
 ` ` ` 
 
 
 
 # # # #   ��HrA]4d�d�S? 
 
 
 
 * * M y S Q L ���]�u�X9^}�.aSe\mEF^�o�Q}* * : 
 
 
 
 1 .   9pY��M y S Q L �? 
 
       ` ` ` b a s h 
 
       #   C e n t O S / R H E L   8 
 
       s u d o   d n f   i n s t a l l   - y   m y s q l - s e r v e r 
 
       s u d o   s y s t e m c t l   s t a r t   m y s q l d 
 
       s u d o   s y s t e m c t l   e n a b l e   m y s q l d 
 
       
 
       #   U b u n t u / D e b i a n 
 
       s u d o   a p t - g e t   i n s t a l l   - y   m y s q l - s e r v e r 
 
       s u d o   s y s t e m c t l   s t a r t   m y s q l 
 
       s u d o   s y s t e m c t l   e n a b l e   m y s q l 
 
       ` ` ` 
 
 
 
 2 .   R��m��HrA]4d�d�b"�&1�W�? 
 
       ` ` ` s q l 
 
       C R E A T E   D A T A B A S E   h r m s _ p r o d u c t i o n   C H A R A C T E R   S E T   u t f 8 m b 4   C O L L A T E   u t f 8 m b 4 _ u n i c o d e _ c i ; 
 
       C R E A T E   U S E R   ' h r m s _ u s e r ' @ ' % '   I D E N T I F I E D   B Y   ' s e c u r e - p a s s w o r d ' ; 
 
       G R A N T   A L L   P R I V I L E G E S   O N   h r m s _ p r o d u c t i o n . *   T O   ' h r m s _ u s e r ' @ ' % ' ; 
 
       F L U S H   P R I V I L E G E S ; 
 
       ` ` ` 
 
 
 
 3 .   |m:j�[M y S Q L ���]�u�? e t c / m y s q l / m y s q l . c o n f . d / m y s q l d . c n f �Y0}
 
       ` ` ` i n i 
 
       [ m y s q l d ] 
 
       i n n o d b _ b u f f e r _ p o o l _ s i z e   =   1 G 
 
       i n n o d b _ l o g _ f i l e _ s i z e   =   2 5 6 M 
 
       m a x _ c o n n e c t i o n s   =   2 0 0 
 
       q u e r y _ c a c h e _ s i z e   =   6 4 M 
 
       ` ` ` 
 
 
 
 # # #   4 . 3   4d�ede��'1��
 
 
 
 # # # #   |m�r�|��'1��pt!}
 
 
 
 1 .   * * ~��\G_`mG�r* * �? 
 
       ` ` ` b a s h 
 
       #   O�.[�k`mG�r`m�d1|
 
       g i t   c l o n e   h t t p s : / / g i t h u b . c o m / y o u r - o r g / h r m s . g i t 
 
       c d   h r m s 
 
       g i t   c h e c k o u t   v 1 . 0 . 0     #   R��V2]R�Hr�[9p1l�Xȓ? 
 
       ` ` ` 
 
 
 
 2 .   * * ,h'v4d�ede* * �? 
 
       ` ` ` b a s h 
 
       #   cm�de$i-W0m��*a�}(��R/p�[?�|Rȓ? 
 
       b a s h   b u i l d . s h   b u i l d 
 
       
 
       #   ��(h�XT�'1*}�t? 
 
       g o   b u i l d   - o   h r m s   m a i n . g o 
 
       ` ` ` 
 
 
 
 3 .   * * R��oP�V�(h�f����1|* * �? 
 
       ` ` ` b a s h 
 
       #   R��m��HrA]4d�d�|˓? 
 
       g o   r u n   c m d / m i g r a t e / m a i n . g o 
 
       
 
       #   R��oP�V�'h�q�~� ��HrA]
 
       g o   r u n   c m d / s q l e x e c / m a i n . g o   - d b   h r m s _ C 0 0 1   - f i l e   s q l / s q l i t e _ i n i t . s q l 
 
       ` ` ` 
 
 
 
 4 .   * * ���]�u�~d��|ȓ�]�Y* * �pWy s t e m d �Y0}
 
 
 
       R��mȓ�]�Y�V"k  ` / e t c / s y s t e m d / s y s t e m / h r m s . s e r v i c e ` �? 
 
       ` ` ` i n i 
 
       [ U n i t ] 
 
       D e s c r i p t i o n = H R M S   A p p l i c a t i o n   S e r v i c e 
 
       A f t e r = n e t w o r k . t a r g e t   m y s q l . s e r v i c e 
 
       
 
       [ S e r v i c e ] 
 
       T y p e = s i m p l e 
 
       U s e r = h r m s 
 
       W o r k i n g D i r e c t o r y = / o p t / h r m s 
 
       E x e c S t a r t = / o p t / h r m s / h r m s 
 
       R e s t a r t = a l w a y s 
 
       R e s t a r t S e c = 5 
 
       E n v i r o n m e n t = H R M S _ E N V = p r o d 
 
       
 
       #   Ó�0T~���]�u
 
       S t a n d a r d O u t p u t = j o u r n a l 
 
       S t a n d a r d E r r o r = j o u r n a l 
 
       
 
       [ I n s t a l l ] 
 
       W a n t e d B y = m u l t i - u s e r . t a r g e t 
 
       ` ` ` 
 
 
 
 5 .   * * Z���Yȓ�]�Y* * �? 
 
       ` ` ` b a s h 
 
       #   ���]�gT��rGms y s t e m d ���]�u
 
       s u d o   s y s t e m c t l   d a e m o n - r e l o a d 
 
       
 
       #   Z��de�����`T�&1GnT�? 
 
       s u d o   s y s t e m c t l   e n a b l e   h r m s 
 
       s u d o   s y s t e m c t l   s t a r t   h r m s 
 
       
 
       #   �Y� ̓�0GnT���Y��? 
 
       s u d o   s y s t e m c t l   s t a t u s   h r m s 
 
       ` ` ` 
 
 
 
 # # # #   9ppt�jV�-h4Q? 
 
 
 
 * * D o c k e r ��'1��* * �? 
 
 
 
 1 .   R��mD o c k e r f i l e �? 
 
       ` ` ` D o c k e r f i l e 
 
       #   ˓�RÕ5���
 
       F R O M   g o l a n g : 1 . 1 8 - a l p i n e   A S   b u i l d e r 
 
       
 
       W O R K D I R   / a p p 
 
       C O P Y   g o . m o d   g o . s u m   . / 
 
       R U N   g o   m o d   d o w n l o a d 
 
       
 
       C O P Y   .   . 
 
       R U N   C G O _ E N A B L E D = 0   G O O S = l i n u x   g o   b u i l d   - a   - i n s t a l l s u f f i x   c g o   - o   h r m s   m a i n . g o 
 
       
 
       #   ig/a�Õ5���
 
       F R O M   a l p i n e : l a t e s t 
 
       
 
       W O R K D I R   / r o o t / 
 
       
 
       #   9pY��n�o�y
 
       R U N   a p k   - - n o - c a c h e   a d d   c a - c e r t i f i c a t e s   t z d a t a 
 
       W O R K D I R   / r o o t / 
 
       
 
       #   `m�^/p�[*mjZ[�2�R�5g)|ig�m�W�V"k
 
       C O P Y   - - f r o m = b u i l d e r   / a p p / h r m s   . 
 
       
 
       #   �o�]�Wȕk� yO�g`m���b���]�u
 
       C O P Y   - - f r o m = b u i l d e r   / a p p / s t a t i c   . / s t a t i c 
 
       C O P Y   - - f r o m = b u i l d e r   / a p p / v i e w s   . / v i e w s 
 
       C O P Y   - - f r o m = b u i l d e r   / a p p / c o n f i g   . / c o n f i g 
 
       
 
       #   R��mȕpo o t "�&1�W
 
       R U N   a d d g r o u p   - g   1 0 0 1   - S   h r m s 
 
       R U N   a d d u s e r   - S   h r m s   - u   1 0 0 1 
 
       U S E R   h r m s 
 
       
 
       #   Ɠ�dvn�~�[_
 
       E X P O S E   8 0 8 0 
 
       
 
       #   ig/a�4d�ede
 
       C M D   [ " . / h r m s " ] 
 
       ` ` ` 
 
 
 
 2 .   ˓�RD o c k e r ���nQ�? 
 
       ` ` ` b a s h 
 
       d o c k e r   b u i l d   - t   h r m s : l a t e s t   . 
 
       ` ` ` 
 
 
 
 3 .   ig/a�9ppt�j�? 
 
       ` ` ` b a s h 
 
       d o c k e r   r u n   - d   \ 
 
           - - n a m e   h r m s   \ 
 
           - p   8 0 8 0 : 8 0 8 0   \ 
 
           - v   $ ( p w d ) / d a t a : / r o o t / d a t a   \ 
 
           - v   $ ( p w d ) / l o g s : / r o o t / l o g s   \ 
 
           - e   H R M S _ E N V = p r o d   \ 
 
           h r m s : l a t e s t 
 
       ` ` ` 
 
 
 
 * * D o c k e r   C o m p o s e ��'1��* * �? 
 
 
 
 1 .   R��md o c k e r - c o m p o s e . y m l �? 
 
       ` ` ` y a m l 
 
       v e r s i o n :   ' 3 . 8 ' 
 
       
 
       s e r v i c e s : 
 
           h r m s : 
 
               b u i l d :   . 
 
               p o r t s : 
 
                   -   " 8 0 8 0 : 8 0 8 0 " 
 
               e n v i r o n m e n t : 
 
                   -   H R M S _ E N V = p r o d 
 
               v o l u m e s : 
 
                   -   . / d a t a : / r o o t / d a t a 
 
                   -   . / l o g s : / r o o t / l o g s 
 
                   -   . / c o n f i g : / r o o t / c o n f i g 
 
               d e p e n d s _ o n : 
 
                   -   m y s q l 
 
               r e s t a r t :   u n l e s s - s t o p p e d 
 
           
 
           m y s q l : 
 
               i m a g e :   m y s q l : 8 . 0 
 
               e n v i r o n m e n t : 
 
                   M Y S Q L _ R O O T _ P A S S W O R D :   r o o t - p a s s w o r d 
 
                   M Y S Q L _ D A T A B A S E :   h r m s _ p r o d u c t i o n 
 
                   M Y S Q L _ U S E R :   h r m s _ u s e r 
 
                   M Y S Q L _ P A S S W O R D :   s e c u r e - p a s s w o r d 
 
               p o r t s : 
 
                   -   " 3 3 0 6 : 3 3 0 6 " 
 
               v o l u m e s : 
 
                   -   m y s q l _ d a t a : / v a r / l i b / m y s q l 
 
                   -   . / s q l / i n i t : / d o c k e r - e n t r y p o i n t - i n i t d b . d 
 
               r e s t a r t :   u n l e s s - s t o p p e d 
 
           
 
           n g i n x : 
 
               i m a g e :   n g i n x : a l p i n e 
 
               p o r t s : 
 
                   -   " 8 0 : 8 0 " 
 
                   -   " 4 4 3 : 4 4 3 " 
 
               v o l u m e s : 
 
                   -   . / n g i n x / n g i n x . c o n f : / e t c / n g i n x / n g i n x . c o n f 
 
                   -   . / n g i n x / s s l : / e t c / n g i n x / s s l 
 
               d e p e n d s _ o n : 
 
                   -   h r m s 
 
               r e s t a r t :   u n l e s s - s t o p p e d 
 
       
 
       v o l u m e s : 
 
           m y s q l _ d a t a : 
 
       ` ` ` 
 
 
 
 2 .   Z���Yȓ�]�Y�? 
 
       ` ` ` b a s h 
 
       d o c k e r - c o m p o s e   u p   - d 
 
       ` ` ` 
 
 
 
 # # #   4 . 4   Y��]�``mG��`���]�u
 
 
 
 # # # #   N g i n x ���]�u
 
 
 
 1 .   9pY��N g i n x �? 
 
       ` ` ` b a s h 
 
       #   C e n t O S / R H E L 
 
       s u d o   y u m   i n s t a l l   - y   n g i n x 
 
       s u d o   s y s t e m c t l   s t a r t   n g i n x 
 
       s u d o   s y s t e m c t l   e n a b l e   n g i n x 
 
       
 
       #   U b u n t u / D e b i a n 
 
       s u d o   a p t - g e t   i n s t a l l   - y   n g i n x 
 
       s u d o   s y s t e m c t l   s t a r t   n g i n x 
 
       s u d o   s y s t e m c t l   e n a b l e   n g i n x 
 
       ` ` ` 
 
 
 
 2 .   R��mH R M S ���]�u�V"k  ` / e t c / n g i n x / c o n f . d / h r m s . c o n f ` �? 
 
       ` ` ` n g i n x 
 
       s e r v e r   { 
 
               l i s t e n   8 0 ; 
 
               s e r v e r _ n a m e   e x a m p l e . c o m ; 
 
               
 
               #   ���]~uZ�TaT T P R�OvT T P S 
 
               r e t u r n   3 0 1   h t t p s : / / $ s e r v e r _ n a m e $ r e q u e s t _ u r i ; 
 
       } 
 
       
 
       s e r v e r   { 
 
               l i s t e n   4 4 3   s s l   h t t p 2 ; 
 
               s e r v e r _ n a m e   e x a m p l e . c o m ; 
 
               
 
               #   S S L �twO�R���]�u
 
               s s l _ c e r t i f i c a t e   / e t c / s s l / c e r t s / e x a m p l e . c o m . c r t ; 
 
               s s l _ c e r t i f i c a t e _ k e y   / e t c / s s l / p r i v a t e / e x a m p l e . c o m . k e y ; 
 
               s s l _ p r o t o c o l s   T L S v 1 . 2   T L S v 1 . 3 ; 
 
               s s l _ c i p h e r s   H I G H : ! a N U L L : ! M D 5 ; 
 
               
 
               #   9p
Y�S�o? 
 
               a d d _ h e a d e r   X - F r a m e - O p t i o n s   D E N Y ; 
 
               a d d _ h e a d e r   X - C o n t e n t - T y p e - O p t i o n s   n o s n i f f ; 
 
               a d d _ h e a d e r   X - X S S - P r o t e c t i o n   " 1 ;   m o d e = b l o c k " ; 
 
               a d d _ h e a d e r   S t r i c t - T r a n s p o r t - S e c u r i t y   " m a x - a g e = 3 1 5 3 6 0 0 0 ;   i n c l u d e S u b D o m a i n s "   a l w a y s ; 
 
               
 
               #   Ó�0T~
 
               a c c e s s _ l o g   / v a r / l o g / n g i n x / h r m s _ a c c e s s . l o g ; 
 
               e r r o r _ l o g   / v a r / l o g / n g i n x / h r m s _ e r r o r . l o g ; 
 
               
 
               #   ȕk� yO�g`m? 
 
               l o c a t i o n   / s t a t i c /   { 
 
                       a l i a s   / o p t / h r m s / s t a t i c / ; 
 
                       e x p i r e s   1 d ; 
 
                       a d d _ h e a d e r   C a c h e - C o n t r o l   " p u b l i c ,   i m m u t a b l e " ; 
 
               } 
 
               
 
               #   `mG��`R�g2|"�? 
 
               l o c a t i o n   /   { 
 
                       p r o x y _ p a s s   h t t p : / / 1 2 7 . 0 . 0 . 1 : 8 0 8 0 ; 
 
                       p r o x y _ s e t _ h e a d e r   H o s t   $ h o s t ; 
 
                       p r o x y _ s e t _ h e a d e r   X - R e a l - I P   $ r e m o t e _ a d d r ; 
 
                       p r o x y _ s e t _ h e a d e r   X - F o r w a r d e d - F o r   $ p r o x y _ a d d _ x _ f o r w a r d e d _ f o r ; 
 
                       p r o x y _ s e t _ h e a d e r   X - F o r w a r d e d - P r o t o   $ s c h e m e ; 
 
                       
 
                       #   �tnTi�tgR�u
 
                       p r o x y _ c o n n e c t _ t i m e o u t   3 0 s ; 
 
                       p r o x y _ s e n d _ t i m e o u t   3 0 s ; 
 
                       p r o x y _ r e a d _ t i m e o u t   3 0 s ; 
 
               } 
 
       } 
 
       ` ` ` 
 
 
 
 3 .   ���]�`N g i n x �? 
 
       ` ` ` b a s h 
 
       s u d o   n g i n x   - t     #   4Z-[/v���]�u
 
       s u d o   s y s t e m c t l   r e s t a r t   n g i n x 
 
       ` ` ` 
 
 
 
 # # #   4 . 5   )�b6^[�EZ�
 
 
 
 # # # #   �~d��|)�b6^
 
 
 
 cm�deP r o m e t h e u s \�O[r a f a n a ig�m��~d��|)�b6^�? 
 
 
 
 1 .   * * 4d�ede)�b6^ƕ�U�W* * �? 
 
       ` ` ` g o 
 
       / /   f�%12|"�$1Q�#Z��YP r o m e t h e u s   m e t r i c s 
 
       i m p o r t   " g i t h u b . c o m / p r o m e t h e u s / c l i e n t _ g o l a n g / p r o m e t h e u s " 
 
       
 
       v a r   ( 
 
               h t t p R e q u e s t s T o t a l   =   p r o m e t h e u s . N e w C o u n t e r V e c ( 
 
                       p r o m e t h e u s . C o u n t e r O p t s { 
 
                               N a m e :   " h t t p _ r e q u e s t s _ t o t a l " , 
 
                               H e l p :   " T o t a l   n u m b e r   o f   H T T P   r e q u e s t s " , 
 
                       } , 
 
                       [ ] s t r i n g { " m e t h o d " ,   " p a t h " ,   " s t a t u s " } , 
 
               ) 
 
               
 
               h t t p R e q u e s t D u r a t i o n   =   p r o m e t h e u s . N e w H i s t o g r a m V e c ( 
 
                       p r o m e t h e u s . H i s t o g r a m O p t s { 
 
                               N a m e :   " h t t p _ r e q u e s t _ d u r a t i o n _ s e c o n d s " , 
 
                               H e l p :   " H T T P   r e q u e s t   d u r a t i o n   i n   s e c o n d s " , 
 
                               B u c k e t s :   p r o m e t h e u s . E x p o n e n t i a l B u c k e t s ( 0 . 0 0 1 ,   2 ,   1 0 ) , 
 
                       } , 
 
                       [ ] s t r i n g { " m e t h o d " ,   " p a t h " } , 
 
               ) 
 
       ) 
 
       
 
       f u n c   i n i t ( )   { 
 
               p r o m e t h e u s . M u s t R e g i s t e r ( h t t p R e q u e s t s T o t a l ) 
 
               p r o m e t h e u s . M u s t R e g i s t e r ( h t t p R e q u e s t D u r a t i o n ) 
 
       } 
 
       ` ` ` 
 
 
 
 2 .   * * ���]�uP r o m e t h e u s * * �gWr o m e t h e u s . y m l �Y0}
 
       ` ` ` y a m l 
 
       g l o b a l : 
 
           s c r a p e _ i n t e r v a l :   1 5 s 
 
       
 
       s c r a p e _ c o n f i g s : 
 
           -   j o b _ n a m e :   ' h r m s ' 
 
               s t a t i c _ c o n f i g s : 
 
                   -   t a r g e t s :   [ ' l o c a l h o s t : 8 0 8 0 ' ] 
 
               m e t r i c s _ p a t h :   ' / m e t r i c s ' 
 
       ` ` ` 
 
 
 
 # # # #   Ó�0T~�~��`
 
 
 
 1 .   * * Ó�0T~���]�u* * �? 
 
       ` ` ` g o 
 
       / /   ���]�uÓ�0T~
 
       i m p o r t   " g i t h u b . c o m / n a t e f i n c h / l u m b e r j a c k " 
 
       
 
       f u n c   s e t u p L o g g e r ( )   { 
 
               l o g F i l e   : =   & l u m b e r j a c k . L o g g e r { 
 
                       F i l e n a m e :   " . / l o g s / h r m s . l o g " , 
 
                       M a x S i z e :     1 0 0 ,   / /   M B 
 
                       M a x B a c k u p s :   5 , 
 
                       M a x A g e :       3 0 ,   / /   d a y s 
 
                       C o m p r e s s :   t r u e , 
 
               } 
 
               
 
               l o g . S e t O u t p u t ( l o g F i l e ) 
 
       } 
 
       ` ` ` 
 
 
 
 2 .   * * cm�deE L K   S t a c k ig�m�Ó�0T~��X�l* * �? 
 
       -   E l a s t i c s e a r c h �-l�hG�@i�tL�%1�b�~ 2)}
 
       -   L o g s t a s h �-l�hG�@i)���U�b^g�2]
 
       -   K i b a n a �-l�hG�@ir_Yt�U�[\�}\�W˓? 
 
 
 
 # # # #   [�EZᰕ�]�u
 
 
 
 cm�deA l e r t m a n a g e r ig�m�[�EZ��? 
 
 
 
 1 .   * * ���]�uA l e r t m a n a g e r * * �EWl e r t m a n a g e r . y m l �Y0}
 
       ` ` ` y a m l 
 
       g l o b a l : 
 
           s m t p _ s m a r t h o s t :   ' y o u r - s m t p - s e r v e r : 5 8 7 ' 
 
           s m t p _ f r o m :   ' a l e r t s @ e x a m p l e . c o m ' 
 
       
 
       r o u t e : 
 
           g r o u p _ b y :   [ ' a l e r t n a m e ' ] 
 
           g r o u p _ w a i t :   1 0 s 
 
           g r o u p _ i n t e r v a l :   1 0 s 
 
           r e p e a t _ i n t e r v a l :   1 h 
 
           r e c e i v e r :   ' w e b . h o o k ' 
 
       
 
       r e c e i v e r s : 
 
           -   n a m e :   ' w e b . h o o k ' 
 
               e m a i l _ c o n f i g s : 
 
                   -   t o :   ' a d m i n @ e x a m p l e . c o m ' 
 
                       s u b j e c t :   ' [ H R M S   A l e r t ]   { {   . G r o u p L a b e l s . a l e r t n a m e   } } ' 
 
                       b o d y :   | 
 
                           { {   r a n g e   . A l e r t s   } } 
 
                           A l e r t :   { {   . A n n o t a t i o n s . s u m m a r y   } } 
 
                           D e s c r i p t i o n :   { {   . A n n o t a t i o n s . d e s c r i p t i o n   } } 
 
                           { {   e n d   } } 
 
       ` ` ` 
 
 
 
 # # #   4 . 6   �o�V$U�~+h�f
 
 
 
 # # # #   ��HrA]4d�d,�`m? 
 
 
 
 1 .   * * M y S Q L w�D��Y�o�V$Ut�-lpn* * �? 
 
       ` ` ` b a s h 
 
       # ! / b i n / b a s h 
 
       #   b a c k u p - m y s q l . s h 
 
       
 
       B A C K U P _ D I R = " / o p t / b a c k u p s / m y s q l " 
 
       D A T E = $ ( d a t e   + % Y % m % d _ % H % M % S ) 
 
       D B _ N A M E = " h r m s _ p r o d u c t i o n " 
 
       
 
       #   R��m�o�V$U)���}
 
       m k d i r   - p   $ B A C K U P _ D I R 
 
       
 
       #   ��F�o�V$U
 
       m y s q l d u m p   - h   l o c a l h o s t   - u   h r m s _ u s e r   - p ' s e c u r e - p a s s w o r d '   $ D B _ N A M E   |   g z i p   >   $ B A C K U P _ D I R / h r m s _ $ D A T E . s q l . g z 
 
       
 
       #   ZoT�`ÓC,�`m�e}�m�o�f3 0 �oK%}
 
       f i n d   $ B A C K U P _ D I R   - n a m e   " * . s q l . g z "   - m t i m e   + 3 0   - d e l e t e 
 
       
 
       #   �tg�}Ó�0T~
 
       e c h o   " $ ( d a t e ) :   ��HrA]4d�d,�`mɅlu��? h r m s _ $ D A T E . s q l . g z "   > >   / v a r / l o g / m y s q l - b a c k u p . l o g 
 
       ` ` ` 
 
 
 
 2 .   * * �tgR�u9p-li�o�V$U* * �? 
 
       ` ` ` b a s h 
 
       #   #Z��YR�qvr o n t a b 
 
       c r o n t a b   - e 
 
       
 
       #   �Y�_I0Q�~\�j2 �ĉ�Xt}\,�`m? 
 
       0   2   *   *   *   / o p t / s c r i p t s / b a c k u p - m y s q l . s h 
 
       ` ` ` 
 
 
 
 # # # #   4d�ede��HrA]�o�V$U
 
 
 
 ` ` ` b a s h 
 
 # ! / b i n / b a s h 
 
 #   b a c k u p - a p p . s h 
 
 
 
 A P P _ D I R = " / o p t / h r m s " 
 
 B A C K U P _ D I R = " / o p t / b a c k u p s / a p p " 
 
 D A T E = $ ( d a t e   + % Y % m % d _ % H % M % S ) 
 
 
 
 #   R��m�o�V$U)���}
 
 m k d i r   - p   $ B A C K U P _ D I R 
 
 
 
 #   �o�V$U4d�ede��HrA]�X�hG�<i� wO{|m�r�g`mAR�t�? 
 
 t a r   - c z f   $ B A C K U P _ D I R / h r m s _ d a t a _ $ D A T E . t a r . g z   - C   $ A P P _ D I R   d a t a   l o g s 
 
 
 
 #   ZoT�`ÓC,�`m? 
 
 f i n d   $ B A C K U P _ D I R   - n a m e   " * . t a r . g z "   - m t i m e   + 7   - d e l e t e 
 
 
 
 e c h o   " $ ( d a t e ) :   4d�ede��HrA]�o�V$U9p~\�W  h r m s _ d a t a _ $ D A T E . t a r . g z "   > >   / v a r / l o g / a p p - b a c k u p . l o g 
 
 ` ` ` 
 
 
 
 # #   5 .   ˓�R�[�0�Scm�de
 
 
 
 H R M S $i-W0m��*a�}\m�U�]�oE�k˓�R�[�0�S��\� 3lC~[ ` b u i l d . s h ` ] ( b u i l d . s h : 1 ) t�-lpn9p�pG^�o1lR�˓�R\��\4Qm�bcT�� � ? 
 
 
 
 # # #   5 . 1   ˓�Rt�-lpn�Y�P*X
 
 
 
 [ ` b u i l d . s h ` ] ( b u i l d . s h : 1 ) ē�uR M S $i-W0m(��RsrG��Q/p�[�TOO��Q}��*a�}\m�U�N�m*[�Ys��e0}
 
 
 
 -   * * 4d�ede˓�R* * :   ,h'vG o 4d�ede�~*[-|
 
 -   * * ��HrA]4d�dx��? * :   ��HrA]4d�d�W�[R`� }O<~�~Gl� <NQ L ��F�
 
 -   * * �[� Y�#b�}T�? * :   �[� Y� bF^�o�Q�`T�#1� zO9Q���]Gm
 
 -   * * ��'1���[�0�S* * :   D o c k e r ���nQ˓�R���O4Q6�|Rȓ�Se��? 
 
 -   * * 4Z-[/v����[* * :   W��f�S4Z-[/v���O�l��-aty�t�f�Xt? 
 
 
 
 �t>��|cm�de�tX[�i�t�\,_p��P` B U I L D _ S C R I P T _ U S A G E . m d ` ] ( B U I L D _ S C R I P T _ U S A G E . m d : 1 ) �V0��? 
 
 
 
 # # #   5 . 2   i��ppn˓�R[�b�b
 
 
 
 # # # #   4d�ede˓�R
 
 
 
 ` ` ` b a s h 
 
 #   ˓�R4d�ede�~*[-|
 
 b a s h   b u i l d . s h   b u i l d 
 
 
 
 #   ˓�R���`M~t? 
 
 b a s h   b u i l d . s h   r u n 
 
 
 
 #   \m�06_˓�R�%X� �Pde\m�^	{Z�}\��Y�.^}
 
 b a s h   b u i l d . s h   b u i l d - l i n u x         #   L i n u x ���Qt_
 
 b a s h   b u i l d . s h   b u i l d - w i n d o w s     #   W i n d o w s ���Qt_
 
 b a s h   b u i l d . s h   b u i l d - d a r w i n       #   m a c O S ���Qt_
 
 ` ` ` 
 
 
 
 # # # #   �[� Y� bF^�o? 
 
 
 
 ` ` ` b a s h 
 
 #   Z���Y�[� Y� bF^�o�Q}Z���9Q���]Gm�? 
 
 b a s h   b u i l d . s h   d e v 
 
 
 
 #   ig/a�4Z-[/v
 
 b a s h   b u i l d . s h   t e s t 
 
 
 
 #   `mG�rR��U=p
 
 b a s h   b u i l d . s h   l i n t 
 
 ` ` ` 
 
 
 
 # # # #   ��HrA]4d�dx��? 
 
 
 
 ` ` ` b a s h 
 
 #   R��m��HrA]4d? 
 
 b a s h   b u i l d . s h   c r e a t e d b 
 
 
 
 #   ��HrA]4d�d<~�~? 
 
 b a s h   b u i l d . s h   m i g r a t e 
 
 
 
 #   S Q L ��F�[�0�S
 
 b a s h   b u i l d . s h   s q l e x e c 
 
 ` ` ` 
 
 
 
 # # #   5 . 3   ��HrA]4d�dOO��u��Yt? 
 
 
 
 # # # #   R��m��HrA]4d? 
 
 
 
 cm�de[ ` c m d / c r e a t e d b / m a i n . g o ` ] ( c m d / c r e a t e d b / m a i n . g o : 1 ) �[�0�SR��m��HrA]4d�d0}
 
 
 
 ` ` ` b a s h 
 
 #   R��mW��fܑ��HrA]4d? 
 
 b a s h   b u i l d . s h   c r e a t e d b   - d b   h r m s _ C 0 0 1 
 
 
 
 #   R��m�o+lܑ��HrA]4d? 
 
 b a s h   b u i l d . s h   c r e a t e d b   - d b   h r m s _ C 0 0 1 , h r m s _ C 0 0 2 
 
 
 
 #   �[�T�WUt�U
m�[�c�tf�'1�k��HrA]4d? 
 
 b a s h   b u i l d . s h   c r e a t e d b   - d b   h r m s _ t e s t   - f o r c e 
 
 ` ` ` 
 
 
 
 # # # #   ��HrA]4d�d<~�~? 
 
 
 
 cm�de[ ` c m d / m i g r a t e / m a i n . g o ` ] ( c m d / m i g r a t e / m a i n . g o : 1 ) �[�0�Sig�m���HrA]4d�d<~�~O0}
 
 
 
 ` ` ` b a s h 
 
 #   ��F���HrA]4d�d<~�~? 
 
 b a s h   b u i l d . s h   m i g r a t e 
 
 
 
 #   ���V~u��HrA]4d�d<~�~? 
 
 b a s h   b u i l d . s h   m i g r a t e   - d b   h r m s _ C 0 0 1 
 
 
 
 #   e��p�|igzO)
 
 b a s h   b u i l d . s h   m i g r a t e   - r o l l b a c k 
 
 ` ` ` 
 
 
 
 # # # #   S Q L ��F�[�0�S
 
 
 
 cm�de[ ` c m d / s q l e x e c / m a i n . g o ` ] ( c m d / s q l e x e c / m a i n . g o : 1 ) �[�0�S��F�S Q L �t^�^_�? 
 
 
 
 1 .   * * ��F�W��fooS Q L * * �? 
 
       ` ` ` b a s h 
 
       #   ̓�0����HrA]
 
       b a s h   b u i l d . s h   s q l e x e c   - d b   h r m s _ C 0 0 1   - s q l   " S E L E C T   *   F R O M   s t a f f   L I M I T   1 0 " 
 
       
 
       #   ǓX[�g��HrA]
 
       b a s h   b u i l d . s h   s q l e x e c   - d b   h r m s _ C 0 0 1   - s q l   " U P D A T E   s t a f f   S E T   e m a i l = ' t e s t @ e x a m p l e . c o m '   W H E R E   i d = 1 " 
 
       ` ` ` 
 
 
 
 2 .   * * ��R_zV��F�S Q L �V"k* * �? 
 
       ` ` ` b a s h 
 
       #   ��F�S Q L �V"k
 
       b a s h   b u i l d . s h   s q l e x e c   - d b   h r m s _ C 0 0 1   - f i l e   s q l / m a i n t e n a n c e . s q l 
 
       ` ` ` 
 
 
 
 3 .   * * \m�00|�[�^Q L * * �? 
 
       ` ` ` b a s h 
 
       #   ig�m�S\m�00|�[�_�[? 
 
       b a s h   b u i l d . s h   s q l e x e c   - d b   h r m s _ C 0 0 1   - i 
 
       ` ` ` 
 
 
 
 �t>��|cm�de�tX[�i�t�\,_p��P` d o c s / s q l e x e c - u s a g e . m d ` ] ( d o c s / s q l e x e c - u s a g e . m d : 1 ) �V0��? 
 
 
 
 # # #   5 . 4   Bi<j��˓�RT��qXQ
 
 
 
 # # # #   D o c k e r ���nQ˓�R
 
 
 
 ` ` ` b a s h 
 
 #   ˓�RD o c k e r ���nQ
 
 b a s h   b u i l d . s h   d o c k e r - b u i l d 
 
 
 
 #   ��)1� No c k e r ���nQ
 
 b a s h   b u i l d . s h   d o c k e r - p u s h 
 
 
 
 #   ˓�R���`M~tL[o c k e r 9ppt�j
 
 b a s h   b u i l d . s h   d o c k e r - r u n 
 
 ` ` ` 
 
 
 
 # # # #   ��'1��V�oTSe��? 
 
 
 
 ` ` ` b a s h 
 
 #   "��q�W��'1��V�? 
 
 b a s h   b u i l d . s h   p a c k a g e 
 
 
 
 #   "��q�W"��q����'1��V�? 
 
 b a s h   b u i l d . s h   p a c k a g e - p r o d 
 
 
 
 #   "��q�W�[� Y�&b4Q�c�[
 
 b a s h   b u i l d . s h   p a c k a g e - d e v 
 
 ` ` ` 
 
 
 
 # # # #   `mG�r�t)1zV�Y� ̓? 
 
 
 
 ` ` ` b a s h 
 
 #   `mG�r͓Nq!}V�? 
 
 b a s h   b u i l d . s h   f m t 
 
 
 
 #   `mG�rȕk� xO�W˓? 
 
 b a s h   b u i l d . s h   v e t 
 
 
 
 #   n�o�y9p
Y�S�Y� ̓? 
 
 b a s h   b u i l d . s h   s e c u r i t y - c h e c k 
 
 
 
 #   "��q�W`mG�rUt�U
m��V�Y[�? 
 
 b a s h   b u i l d . s h   c o v e r a g e 
 
 ` ` ` 
 
 
 
 # # #   5 . 5   w�D�~u�mY/p�[p�bcT�? 
 
 
 
 Y��N��3lC~��A%Mw[ ` b u i l d . s h ` ] ( b u i l d . s h : 1 ) t�-lpn#Z��Yw�D�~u�mY/p�[p�bcT�&0}
 
 
 
 ` ` ` b a s h 
 
 #   #Z��Yw�D�~u�mY/p�[�T�V��? 
 
 f u n c t i o n   c u s t o m _ t a s k ( )   { 
 
         e c h o   " ��F�w�D�~u�mY/p�[p�bcT�? . . " 
 
         #   w�D�~u�mY� f�}
 
 } 
 
 
 
 #   Op�UbcT�!JWT��r�W�mf|Rȓ? 
 
 c a s e   " $ 1 "   i n 
 
         #   O�5g�|c a s e . . . 
 
         " c u s t o m " ) 
 
                 c u s t o m _ t a s k 
 
                 ; ; 
 
         * ) 
 
                 #   �i?j{�t|\�
 
                 ; ; 
 
 e s a c 
 
 ` ` ` 
 
 
 
 # # #   5 . 6   ˓�Rȓ� cm�Q�u�t? 
 
 
 
 1 .   * * ��zO;uƕ�U�W* * �? 
 
       -   cm�de˓�Rt�-lpn��F�C I / C D 4ZzO�%
 
       -   w�D��YV�(hty�t�f�b�t)1zV�Y� ̓? 
 
       -   w�D��Y˓�R\��\4Q? 
 
 
 
 2 .   * * ��h�ŕ�e��* * �? 
 
       -   cm�de�m�]�`(��R�S��g`m��/\R��UF^�o? 
 
       -   cm�de��h�Y�@jzV�~��`���_�R�m!O
 
       -   �~��Z~˓�R��h�m� w�X[� ? 
 
 
 
 3 .   * * ��FXQ|m:j�[* * �? 
 
       -   cm�de���`�˓�RT��r� �q*}�t? 
 
       -   �d�tn�o�yQ��_�v�m-[GmÓX�h
 
       -   R��U=p˓�R!�Xm垚5g-}V�? 
 
 
 
 4 .   * * ��k��o�R�`* * �? 
 
       -   ˓�R�o���Ó5�A_n�m�zœ4OJe�t��O��? 
 
       -   9p�pG^˓�R�5�� yO��̓�0�be��p�|
 
       -   �tg�}˓�RÓ�0T~n8Y,|��}库�caq
 
 
 
 # # #   5 . 7   ��tT�k���c�j
 
 
 
 # # # #   /uLkF���}�Y�EZP�k��g�Y? 
 
 
 
 1 .   * * ,h'v��k��* * �? 
 
       ` ` ` b a s h 
 
       #   �Y� ̓M�o ��h�
 
       g o   v e r s i o n 
 
       
 
       #   ZoT�`�Y3 ao�d�t
 
       g o   c l e a n   - m o d c a c h e 
 
       
 
       #   ���]�g�m-[Gmn�o�y
 
       g o   m o d   d o w n l o a d 
 
       ` ` ` 
 
 
 
 2 .   * * ��HrA]4d�d[~���0�h�h? * �? 
 
       ` ` ` b a s h 
 
       #   �Y� ̓�0�f����1|���]�u
 
       b a s h   b u i l d . s h   s q l e x e c   - d b   h r m s _ C 0 0 1   - s q l   " S E L E C T   1 " 
 
       
 
       #   ���]�gR��m��HrA]4d? 
 
       b a s h   b u i l d . s h   c r e a t e d b   - d b   h r m s _ C 0 0 1   - f o r c e 
 
       b a s h   b u i l d . s h   m i g r a t e 
 
       ` ` ` 
 
 
 
 3 .   * * ɓ�Q�j��}�* * �? 
 
       ` ` ` b a s h 
 
       #   �~��Z~t�-lpnȓY�Xt~\Hoĕ? 
 
       c h m o d   + x   b u i l d . s h 
 
       
 
       #   �Y� ̓�00m0��fHoĕ? 
 
       l s   - l a   s c r i p t s / 
 
       ` ` ` 
 
 
 
 4 .   * * �~�[_W��rde* * �? 
 
       ` ` ` b a s h 
 
       #   �Y� ̓�0l�Y�E�0]"�? 
 
       n e t s t a t   - t l n p   |   g r e p   : 8 0 8 0 
 
       
 
       #   ɓ� �Y�0]"�(1X~�~? 
 
       k i l l   - 9   < P I D > 
 
       ` ` ` 
 
 
 
 # #   6 .   �[� Y�b6ncm�Q�u�t? 
 
 
 
 # # #   6 . 1   �Xpn��C�W
 
 
 
 # # # #   G i t �[�0�}4Z? 
 
 
 
 H R M S $i-W0m��(1]cm�deG i t   F l o w �[�0�}4Z�O0}
 
 
 
 1 .   * * �m�W��? * �? 
 
       -   ` m a i n ` :   "��q����h�R��Une
 
       -   ` d e v e l o p ` :   �[� Y�b�[R��Une
 
 
 
 2 .   * * HgmT�YR��Une* * �? 
 
       -   ` f e a t u r e / * ` :   T��qXQ�[� Y�b�W��? 
 
       -   ` r e l e a s e / * ` :   Y�b�zQ��U,�R��Une
 
       -   ` h o t f i x / * ` :   �~D� �0ha�o�]�W��? 
 
 
 
 # # # #   ��*a&lYt�R�[
 
 
 
 ` ` ` b a s h 
 
 #   ��*a&lZXO͓Nq!}
 
 < t y p e > ( < s c o p e > ) :   < s u b j e c t > 
 
 
 
 #   �~�7p
 
 f e a t :   g�Ys�? 
 
 f i x :   ��k���m��2�
 
 d o c s :   �V0ǓX[�g
 
 s t y l e :   `mG�r͓Nq!}�t�Q�f
 
 r e f a c t o r :   `mG�r���]/p
 
 t e s t :   4Z-[/v)�?z�S
 
 c h o r e :   ˓�R�[�0�S��,h�}T�A%OO�Θ�kY�:j�Y
 
 
 
 #   �~p��}
 
 f e a t ( s t a f f ) :   #Z��Y[�:jO��R_zV5pNq�ST��qXQ
 
 f i x ( a u t h ) :   �m��2�Yt�c�Xɓ�Q�j`i�\	v��k��
 
 d o c s ( r e a d m e ) :   ǓX[�g9pY��tX[�i
 
 ` ` ` 
 
 
 
 # # #   6 . 2   ��zO;uƕ�U�W/ ��zO;u��'1��
 
 
 
 # # # #   C I / C D 4ZzO�%
 
 
 
 1 .   * * `mG�r��*a&l* * �,l}Y�#b� nTA_\m�0,U.�xO�WT��qXQR��Une
 
 2 .   * * `mG�r�Y� ̓? * �3l�VT�(1M~t|\,U.�yOxr�[�_��̓�0�bȕk� xO�W˓? 
 
 3 .   * * ˓�R4Z-[/v* * �1l*}�tb,U.�xO߂ig/a�W��f�S4Z-[/v
 
 4 .   * * ƕ�U�W4Z-[/v* * �6l4Q�c�W4Z-[/v��h�ig/a�ƕ�U�W4Z-[/v
 
 5 .   * * ��'1��Y�b�z* * �6l� 3lC~��� ȓYty�t�f�`w�D��Y��'1��
 
 
 
 # # # #   G i t H u b   A c t i o n s ���]�u�~p��}
 
 
 
 ` ` ` y a m l 
 
 #   . g i t h u b / w o r k f l o w s / c i . y m l 
 
 n a m e :   C I 
 
 
 
 o n : 
 
     p u s h : 
 
         b r a n c h e s :   [   m a i n ,   d e v e l o p   ] 
 
     p u l l _ r e q u e s t : 
 
         b r a n c h e s :   [   m a i n ,   d e v e l o p   ] 
 
 
 
 j o b s : 
 
     t e s t : 
 
         r u n s - o n :   u b u n t u - l a t e s t 
 
 
 
         s e r v i c e s : 
 
             m y s q l : 
 
                 i m a g e :   m y s q l : 8 . 0 
 
                 e n v : 
 
                     M Y S Q L _ R O O T _ P A S S W O R D :   r o o t 
 
                     M Y S Q L _ D A T A B A S E :   h r m s _ t e s t 
 
                 p o r t s : 
 
                     -   3 3 0 6 : 3 3 0 6 
 
                 o p t i o n s :   - - h e a l t h - c m d = " m y s q l a d m i n   p i n g "   - - h e a l t h - i n t e r v a l = 1 0 s   - - h e a l t h - t i m e o u t = 5 s   - - h e a l t h - r e t r i e s = 3 
 
 
 
         s t e p s : 
 
         -   u s e s :   a c t i o n s / c h e c k o u t @ v 2 
 
 
 
         -   n a m e :   S e t   u p   G o 
 
             u s e s :   a c t i o n s / s e t u p - g o @ v 2 
 
             w i t h : 
 
                 g o - v e r s i o n :   1 . 1 8 
 
 
 
         -   n a m e :   C a c h e   G o   m o d u l e s 
 
             u s e s :   a c t i o n s / c a c h e @ v 2 
 
             w i t h : 
 
                 p a t h :   ~ / g o / p k g / m o d 
 
                 k e y :   $ { {   r u n n e r . o s   } } - g o - $ { {   h a s h F i l e s ( ' * * / g o . s u m ' )   } } 
 
                 r e s t o r e - k e y s :   | 
 
                     $ { {   r u n n e r . o s   } } - g o - 
 
 
 
         -   n a m e :   B u i l d 
 
             r u n :   g o   b u i l d   - v   . / . . . 
 
 
 
         -   n a m e :   T e s t 
 
             r u n :   g o   t e s t   - v   - r a c e   - c o v e r p r o f i l e = c o v e r a g e . o u t   . / . . . 
 
         
 
         -   n a m e :   U p l o a d   c o v e r a g e 
 
             u s e s :   c o d e c o v / c o d e c o v - a c t i o n @ v 1 
 
             w i t h : 
 
                 f i l e :   . / c o v e r a g e . o u t 
 
 ` ` ` 
 
 
 
 # # #   6 . 3   ��FXQ|m:j�[
 
 
 
 # # # #   ��HrA]4d�d-}V�? 
 
 
 
 1 .   * * ̓�0��|m:j�[* * �? 
 
       -   cm�de���P�}(��R�P�[? 
 
       -   ���W�SN + 1 ̓�0����}�
 
       -   cm�deR��U	0Q��_�v��HrA]|m�r�}
 
 
 
 2 .   * * ig�p4^�Y�r�S? * �? 
 
       ` ` ` g o 
 
       / /   ���]�u��HrA]4d�d[~���0\w
 
       d b ,   e r r   : =   g o r m . O p e n ( m y s q l . O p e n ( d s n ) ,   & g o r m . C o n f i g { } ) 
 
       
 
       s q l D B ,   e r r   : =   d b . D B ( ) 
 
       s q l D B . S e t M a x I d l e C o n n s ( 1 0 ) 
 
       s q l D B . S e t M a x O p e n C o n n s ( 1 0 0 ) 
 
       s q l D B . S e t C o n n M a x L i f e t i m e ( t i m e . H o u r ) 
 
       ` ` ` 
 
 
 
 # # # #   4d�ede|m:j�[
 
 
 
 1 .   * * �d�t�~+h�f* * �? 
 
       ` ` ` g o 
 
       / /   cm�deR e d i s �d�t
 
       i m p o r t   " g i t h u b . c o m / g o - r e d i s / r e d i s / v 8 " 
 
       
 
       r d b   : =   r e d i s . N e w C l i e n t ( & r e d i s . O p t i o n s { 
 
               A d d r :           " l o c a l h o s t : 6 3 7 9 " , 
 
               P a s s w o r d :   " " , 
 
               D B :               0 , 
 
       } ) 
 
       ` ` ` 
 
 
 
 2 .   * * ����B_�o�R�`* * �? 
 
       ` ` ` g o 
 
       / /   cm�deG o W��_�%�o�R�`����B_�t�0w
 
       g o   f u n c ( )   { 
 
               / /   �[�P�o�R�``m��Y
 
       } ( ) 
 
       ` ` ` 
 
 
 
 # # #   6 . 4   9p
Y�Sȓ� cm�Q�u�t? 
 
 
 
 # # # #   엡�$U`i�\	v�m�^�]ɓ? 
 
 
 
 1 .   * * 5p�Ur9p
Y�S* * �? 
 
       ` ` ` g o 
 
       i m p o r t   " g o l a n g . o r g / x / c r y p t o / b c r y p t " 
 
       
 
       / /   5p�Ur]�X{
 
       h a s h e d P a s s w o r d ,   e r r   : =   b c r y p t . G e n e r a t e F r o m P a s s w o r d ( [ ] b y t e ( p a s s w o r d ) ,   b c r y p t . D e f a u l t C o s t ) 
 
       
 
       / /   5p�Ur`i�\	v
 
       e r r   : =   b c r y p t . C o m p a r e H a s h A n d P a s s w o r d ( h a s h e d P a s s w o r d ,   [ ] b y t e ( p a s s w o r d ) ) 
 
       ` ` ` 
 
 
 
 2 .   * * J W T `m�0�X* * �? 
 
       ` ` ` g o 
 
       / /   "��q�WJ W T `m�0�X
 
       t o k e n   : =   j w t . N e w W i t h C l a i m s ( j w t . S i g n i n g M e t h o d H S 2 5 6 ,   j w t . M a p C l a i m s { 
 
               " u s e r n a m e " :   u s e r n a m e , 
 
               " e x p " :             t i m e . N o w ( ) . A d d ( t i m e . H o u r   *   2 4 ) . U n i x ( ) , 
 
       } ) 
 
       
 
       t o k e n S t r i n g ,   e r r   : =   t o k e n . S i g n e d S t r i n g ( [ ] b y t e ( s e c r e t K e y ) ) 
 
       ` ` ` 
 
 
 
 # # # #   ��HrA]�m�o�Y
 
 
 
 1 .   * * S Q L 	Z%1�SÕ�S�Y* * �? 
 
       -   cm�deY��P�fV�(haq�t? 
 
       -   `i�\	vHg�d�S��HrA]
 
       -   cm�deO R M (��R4U��Z~��? 
 
 
 
 2 .   * * X S S Õ�S�Y* * �? 
 
       -   Hg�d�V��HrA]Ó�`X~tR[T M L ^g���{
 
       -   cm�deP�mT��9p
Y�S�~+h�f( C S P ) 
 
       -   `i�\	v\�}\cVV�+hde���u�}O�? 
 
 
 
 3 .   * * C S R F Õ�S�Y* * �? 
 
       ` ` ` g o 
 
       / /   cm�deC S R F �mb��h`m? 
 
       r . U s e ( c s r f . M i d d l e w a r e ( c s r f . O p t i o n s { 
 
               S e c r e t :   " c s r f - s e c r e t - k e y " , 
 
       } ) ) 
 
       ` ` ` 
 
 
 
 # #   7 .   ��tT�k���c�j�m�^�m��? 
 
 
 
 # # #   7 . 1   /uLkF���}�YtE��U
 
 
 
 # # # #   4d�edeZ���Y��}�
 
 
 
 1 .   * * �~�[_W��rde* * �? 
 
       ` ` ` b a s h 
 
       #   ̓�0En�~�[_W��rde
 
       n e t s t a t   - t l n p   |   g r e p   : 8 0 8 0 
 
       
 
       #   X�ig�m�%
 
       k i l l   - 9   < P I D > 
 
       ` ` ` 
 
 
 
 2 .   * * ���]�u�V"k��k��* * �? 
 
       ` ` ` b a s h 
 
       #   `i�\	vY A M L ���]�u�V"k
 
       g o   r u n   m a i n . g o   - c h e c k - c o n f i g 
 
       ` ` ` 
 
 
 
 3 .   * * ��HrA]4d�d[~���0Q0�t? * �? 
 
       ` ` ` b a s h 
 
       #   4Z-[/v��HrA]4d�d[~��? 
 
       b a s h   b u i l d . s h   s q l e x e c   - d b   h r m s _ C 0 0 1   - s q l   " S E L E C T   1 " 
 
       ` ` ` 
 
 
 
 # # # #   ��FXQ��}�
 
 
 
 1 .   * * P�mT�t	Z�R!}* * �? 
 
       ` ` ` b a s h 
 
       #   ̓�0EnP�mT�tcm�de
 
       p s   a u x   |   g r e p   h r m s 
 
       
 
       #   cm�dep p r o f R��U=p
 
       g o   t o o l   p p r o f   h t t p : / / l o c a l h o s t : 8 0 8 0 / d e b u g / p p r o f / h e a p 
 
       ` ` ` 
 
 
 
 2 .   * * C P U cm�de��V�s* * �? 
 
       ` ` ` b a s h 
 
       #   cm�dep p r o f R��U=pC P U 
 
       g o   t o o l   p p r o f   h t t p : / / l o c a l h o s t : 8 0 8 0 / d e b u g / p p r o f / p r o f i l e 
 
       ` ` ` 
 
 
 
 # # #   7 . 2   Ó�0T~R��U=p
 
 
 
 # # # #   4d�edeÓ�0T~
 
 
 
 H R M S �~d��|"��q�W(��R�hG�Ai�g`m5g�}\m�]l o g s / ` )���}�? 
 
 
 
 -   ` h r m s . l o g ` :   4d�ede�m�~�hG�? 
 
 -   ` a c c e s s . l o g ` :   H T T P �tWW�hÓ�0T~
 
 -   ` e r r o r . l o g ` :   ��k��Ó�0T~
 
 
 
 # # # #   Ó�0T~R��U=p[�b�b
 
 
 
 ` ` ` b a s h 
 
 #   ̓�0Enȓ� ig b�k��k��
 
 t a i l   - f   e r r o r . l o g 
 
 
 
 #   ̓�0En�tWW�h�qx�
 
 a w k   ' { p r i n t   $ 1 } '   a c c e s s . l o g   |   s o r t   |   u n i q   - c   |   s o r t   - n r 
 
 
 
 #   ̓�0En�pt~uI P (��R��? 
 
 g r e p   " 1 9 2 . 1 6 8 . 1 . 1 0 0 "   a c c e s s . l o g 
 
 ` ` ` 
 
 
 
 # # #   7 . 3   )�b6^�m�^ᶓ? 
 
 
 
 # # # #   O��bme���V#r)�b6^
 
 
 
 1 .   * * �~d��|���V#r* * �? 
 
       -   C P U cm�de�? 
 
       -   P�mT�tcm�de�? 
 
       -   �~zOmcm�de�? 
 
       -    b�|4Z�OzV
 
 
 
 2 .   * * 4d�ede���V#r* * �? 
 
       -   �t�0w]��]2|ÓX�h
 
       -   �t�0w��,a�Y�? 
 
       -   ��k���? 
 
       -   2Zflz"�&1�W��? 
 
 
 
 # # # #   �t=��YYt�R�W
 
 
 
 ` ` ` y a m l 
 
 #   �t=��YYt�R�W�~p��}
 
 g r o u p s : 
 
     -   n a m e :   h r m s . r u l e s 
 
         r u l e s : 
 
             -   a l e r t :   H i g h E r r o r R a t e 
 
                 e x p r :   r a t e ( h t t p _ r e q u e s t s _ t o t a l { s t a t u s = ~ " 5 . . " } [ 5 m ] )   >   0 . 0 5 
 
                 f o r :   2 m 
 
                 l a b e l s : 
 
                     s e v e r i t y :   c r i t i c a l 
 
                 a n n o t a t i o n s : 
 
                     s u m m a r y :   " H R M S 4d�ede��k����VC~Bi? 
 
                     d e s c r i p t i o n :   " ��k����Vjnig�VS^5 R��UcP�pT�yig? % " 
 
             
 
             -   a l e r t :   H i g h R e s p o n s e T i m e 
 
                 e x p r :   h i s t o g r a m _ q u a n t i l e ( 0 . 9 5 ,   r a t e ( h t t p _ r e q u e s t _ d u r a t i o n _ s e c o n d s _ b u c k e t [ 5 m ] ) )   >   1 
 
                 f o r :   5 m 
 
                 l a b e l s : 
 
                     s e v e r i t y :   w a r n i n g 
 
                 a n n o t a t i o n s : 
 
                     s u m m a r y :   " H R M S 4d�ede]��]2|ÓX�hig�V�f" 
 
                     d e s c r i p t i o n :   " 9 5 % (��R���Y�P7d4d�ei�x�yig? �~? 
 
 ` ` ` 
 
 
 
 # # #   7 . 4   �o�V$U�m�^�N�o? 
 
 
 
 # # # #   w�D��Y�o�V$Ut�-lpn
 
 
 
 ` ` ` b a s h 
 
 # ! / b i n / b a s h 
 
 #   b a c k u p . s h 
 
 
 
 B A C K U P _ D I R = " / o p t / b a c k u p s / h r m s " 
 
 D A T E = $ ( d a t e   + % Y % m % d _ % H % M % S ) 
 
 
 
 #   R��m�o�V$U)���}
 
 m k d i r   - p   $ B A C K U P _ D I R 
 
 
 
 #   �o�V$U��HrA]4d? 
 
 m y s q l d u m p   - h   l o c a l h o s t   - u   h r m s _ u s e r   - p ' p a s s w o r d '   h r m s _ p r o d u c t i o n   |   g z i p   >   $ B A C K U P _ D I R / d b _ $ D A T E . s q l . g z 
 
 
 
 #   �o�V$U4d�ede��HrA]
 
 t a r   - c z f   $ B A C K U P _ D I R / a p p _ $ D A T E . t a r . g z   - C   / o p t / h r m s   d a t a   l o g s 
 
 
 
 #   ZoT�`ÓC,�`m? 
 
 f i n d   $ B A C K U P _ D I R   - n a m e   " * . g z "   - m t i m e   + 3 0   - d e l e t e 
 
 
 
 e c h o   " $ ( d a t e ) :   �o�V$U9p~\�W"   > >   / v a r / l o g / h r m s - b a c k u p . l o g 
 
 ` ` ` 
 
 
 
 # # # #   �� 22�4ZzO�%
 
 
 
 1 .   * * ��HrA]4d�d�N�o? * �? 
 
       ` ` ` b a s h 
 
       g u n z i p   <   d b _ 2 0 2 3 1 2 0 1 _ 1 2 0 0 0 0 . s q l . g z   |   m y s q l   - u   h r m s _ u s e r   - p   h r m s _ p r o d u c t i o n 
 
       ` ` ` 
 
 
 
 2 .   * * 4d�ede��HrA]�� 22�* * �? 
 
       ` ` ` b a s h 
 
       t a r   - x z f   a p p _ 2 0 2 3 1 2 0 1 _ 1 2 0 0 0 0 . t a r . g z   - C   / o p t / h r m s 
 
       ` ` ` 
 
 
 
 # #   �d��
 
 
 
 H R M S �~d��|(��R}Y�b{��'1�����V!]Z5u
m\m�U�|�[� Y� bF^�o�Q�`�[�T�W"��q����h�ig.a�m(��R�S4ZzO�%�|\��[� Y�b�big.a�me�$2�i��*a�}\m�U�Sȕ"2�k���V�ᆒ�P� 3lC~��[��`ȓ��[W�>iQ�(��R6ncm�Q�u�t�x}e�$2�iY��NBi;jef��xOhuO�%1tn�[� Y�b�b��'1��H R M S �~d��|��\ �m�o�S�~�Q~u��C�bY��lo��A� ? 
 
 
 
 ��zO;u��ExX~ē����q�fȓ�qB_^p�f�kO��bme�}\mÕ�q2|9p-lan9p!aq\�~\?mg}Y�bfy�~([� �O4Q,��t#��0�b)�b6^ĉ
��|\�N���P2|�m�]�gY�:j�[(��R6n�Y�P�b��� ȓ�B_^p�f� 
 
 